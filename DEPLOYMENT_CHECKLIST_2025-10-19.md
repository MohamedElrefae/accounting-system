# Deployment Checklist: transaction_line_items to transaction_lines Migration\n\n**Date:** 2025-10-19  \n**Version:** 1.0  \n**Status:** Ready for Deployment\n\n---\n\n## Pre-Deployment Tasks\n\n### Database Preparation\n- [ ] **Backup Database**\n  - Create Supabase backup via dashboard\n  - Export critical tables as CSV/JSON for safety\n  - Document backup location and timestamp\n\n- [ ] **Review Migration Files**\n  - [ ] `migrations/2025-10-19_migrate_line_items_to_transaction_lines.sql`\n  - [ ] `migrations/2025-10-19_update_document_associations_constraints.sql`\n  - [ ] Verify SQL syntax in SQL formatter\n  - [ ] Confirm no hardcoded IDs or environment-specific data\n\n- [ ] **Test in Development Environment** (if available)\n  - [ ] Create dev database clone\n  - [ ] Run migration 1 and verify\n  - [ ] Run migration 2 and verify\n  - [ ] Test document linking\n  - [ ] Verify data integrity\n\n### Code Review\n- [ ] **Service Layer Changes**\n  - [ ] Review `src/services/transaction-line-items.ts` diff\n  - [ ] Review `src/services/documents.ts` diff\n  - [ ] Check TypeScript compilation: `npm run typecheck`\n  - [ ] Verify no ESLint warnings: `npm run lint`\n\n- [ ] **Component Changes**\n  - [ ] Review `src/components/documents/AttachDocumentsPanel.tsx` diff\n  - [ ] Review `src/pages/Transactions/TransactionLinesTable.tsx` diff\n  - [ ] Test component rendering in dev environment\n  - [ ] Verify no prop type errors\n\n### Documentation Review\n- [ ] **Migration Guide**\n  - [ ] `docs/TRANSACTION_LINE_ITEMS_MIGRATION_GUIDE.md` complete\n  - [ ] All SQL queries included and tested\n  - [ ] Troubleshooting section covers known issues\n  - [ ] Rollback plan is clear and complete\n\n- [ ] **Implementation Summary**\n  - [ ] `IMPLEMENTATION_SUMMARY_2025-10-19.md` accurate\n  - [ ] All files listed and described\n  - [ ] Architecture diagram correct\n  - [ ] Performance section realistic\n\n---\n\n## Deployment Steps\n\n### Phase 1: Database Migration (30 minutes)\n\n#### Step 1.1: Apply First Migration\n```bash\n# In Supabase SQL Editor, run:\n# migrations/2025-10-19_migrate_line_items_to_transaction_lines.sql\n```\n- [ ] Open Supabase SQL Editor\n- [ ] Copy entire migration SQL\n- [ ] Execute in SQL Editor\n- [ ] Wait for completion (should be ~1-2 seconds)\n- [ ] Check for errors in output\n\n#### Step 1.2: Verify First Migration\n```sql\nSELECT \n  COUNT(*) as total_line_items,\n  COUNT(transaction_line_id) as mapped_to_lines,\n  COUNT(transaction_line_id) * 100.0 / COUNT(*) as success_percentage\nFROM public.transaction_line_items;\n```\n- [ ] Run verification query in SQL Editor\n- [ ] Document results\n- [ ] Success should be close to 100% (minor gaps ok for new records)\n- [ ] If < 90% success, investigate before proceeding\n\n#### Step 1.3: Apply Second Migration\n```bash\n# In Supabase SQL Editor, run:\n# migrations/2025-10-19_update_document_associations_constraints.sql\n```\n- [ ] Copy entire migration SQL\n- [ ] Execute in SQL Editor\n- [ ] Check for errors in output\n- [ ] Verify completion\n\n#### Step 1.4: Verify Second Migration\n```sql\nSELECT \n  column_name, \n  constraint_type \nFROM information_schema.key_column_usage \nWHERE table_name = 'document_associations' \nAND constraint_name LIKE '%entity_type%';\n```\n- [ ] Run verification query\n- [ ] Confirm `valid_entity_type` constraint exists\n- [ ] Check that it's a CHECK constraint\n\n### Phase 2: Code Deployment (20 minutes)\n\n#### Step 2.1: Build Application\n```bash\ncd /path/to/project\nnpm run lint\nnpm run typecheck\nnpm run build\n```\n- [ ] No TypeScript errors\n- [ ] No ESLint errors\n- [ ] Build completes successfully\n- [ ] Build artifacts generated without warnings\n\n#### Step 2.2: Deploy Code\n- [ ] Commit changes to Git: `git add . && git commit -m \"feat: migrate transaction_line_items to transaction_lines\"`\n- [ ] Push to deployment branch\n- [ ] Trigger CI/CD pipeline\n- [ ] Monitor deployment logs\n- [ ] Verify deployment completed successfully\n\n#### Step 2.3: Verify Application Startup\n- [ ] Application starts without errors\n- [ ] Check browser console (F12 → Console tab)\n- [ ] No critical errors in logs\n- [ ] API endpoints responding\n\n### Phase 3: Functionality Testing (30 minutes)\n\n#### Step 3.1: Basic Navigation\n- [ ] Login to application\n- [ ] Navigate to Transactions page\n- [ ] Load a transaction with existing line items\n- [ ] Verify line items display correctly\n- [ ] No console errors\n\n#### Step 3.2: Document Attachment\n- [ ] Click document icon on a transaction line\n- [ ] Verify document panel opens\n- [ ] Upload a test document\n- [ ] Verify document appears in list\n- [ ] Check document count badge on line\n- [ ] Document count = 1\n\n#### Step 3.3: Multiple Documents\n- [ ] Upload second document to same line\n- [ ] Verify both documents appear\n- [ ] Check document count badge = 2\n- [ ] Remove one document\n- [ ] Verify count updates to 1\n- [ ] Remove second document\n- [ ] Verify count updates to 0\n\n#### Step 3.4: Different Lines\n- [ ] Select different transaction line\n- [ ] Upload document to new line\n- [ ] Switch back to first line\n- [ ] Verify first line still shows 0 documents (or previous count)\n- [ ] Switch to second line\n- [ ] Verify it shows 1 document\n\n#### Step 3.5: Transaction-Level Operations\n- [ ] Test transaction creation (if applicable)\n- [ ] Test transaction editing\n- [ ] Test transaction deletion\n- [ ] Verify no errors during operations\n- [ ] Verify line items persist correctly\n\n#### Step 3.6: Existing Data\n- [ ] Verify existing transactions load\n- [ ] Verify existing line items appear\n- [ ] Verify existing documents still accessible\n- [ ] No data loss observed\n\n### Phase 4: Advanced Testing (20 minutes)\n\n#### Step 4.1: Performance\n- [ ] Open DevTools → Network tab\n- [ ] Load transaction with many line items (>20)\n- [ ] Monitor request times\n- [ ] Should be < 2 seconds per request\n- [ ] No excessive API calls\n\n#### Step 4.2: Error Handling\n- [ ] Try to upload invalid file (if applicable)\n- [ ] Observe error handling\n- [ ] Try to delete document while panel open\n- [ ] Try concurrent document uploads\n- [ ] All handled gracefully\n\n#### Step 4.3: Browser Compatibility\n- [ ] Test in Chrome\n- [ ] Test in Firefox\n- [ ] Test in Safari (if available)\n- [ ] Test in Edge (if available)\n- [ ] All browsers work correctly\n\n#### Step 4.4: Mobile Responsiveness (if applicable)\n- [ ] Test on tablet view\n- [ ] Test on mobile view\n- [ ] Document panel responsive\n- [ ] Line items table responsive\n- [ ] Controls accessible on small screens\n\n---\n\n## Post-Deployment Tasks\n\n### Monitoring (First 24 Hours)\n- [ ] Monitor application error logs\n  - [ ] Check for constraint violations\n  - [ ] Check for NULL pointer exceptions\n  - [ ] Check for permission errors\n  - [ ] Error rate should be normal\n\n- [ ] Monitor database performance\n  - [ ] Check query execution times\n  - [ ] Watch for slow queries\n  - [ ] Monitor connection pool\n  - [ ] Check disk usage\n\n- [ ] Collect user feedback\n  - [ ] Any reported issues?\n  - [ ] Performance acceptable?\n  - [ ] UI working as expected?\n  - [ ] Documents attaching correctly?\n\n### Documentation\n- [ ] Update CHANGELOG.md with deployment info\n- [ ] Update README.md if needed\n- [ ] Post announcement in team chat\n- [ ] Update internal wiki/documentation\n- [ ] Archive this checklist with completed items\n\n### Sign-Off\n- [ ] **QA Lead:** Approve functionality testing\n  - Name: _______________\n  - Date: _______________\n  - Notes: _______________\n\n- [ ] **Database Admin:** Approve database changes\n  - Name: _______________\n  - Date: _______________\n  - Notes: _______________\n\n- [ ] **Tech Lead:** Approve code deployment\n  - Name: _______________\n  - Date: _______________\n  - Notes: _______________\n\n---\n\n## Rollback Procedures\n\n### If Issues Occur (Choose Appropriate Level)\n\n#### Option 1: Immediate Rollback (if critical issues within 1 hour)\n```bash\n# 1. Stop application\n\n# 2. Revert database (in Supabase SQL Editor)\nALTER TABLE transaction_line_items DROP CONSTRAINT fk_tli_transaction_line;\nALTER TABLE transaction_line_items DROP COLUMN transaction_line_id;\nDROP VIEW IF EXISTS v_transaction_line_items_with_context;\nALTER TABLE document_associations DROP CONSTRAINT valid_entity_type;\nALTER TABLE document_associations ADD CONSTRAINT valid_entity_type \n  CHECK (entity_type IN ('transaction', 'transaction_line', 'invoice', 'purchase_order', 'payment'));\n\n# 3. Revert code\ngit checkout src/services/transaction-line-items.ts\ngit checkout src/services/documents.ts\ngit checkout src/components/documents/AttachDocumentsPanel.tsx\ngit checkout src/pages/Transactions/TransactionLinesTable.tsx\n\n# 4. Redeploy previous version\n\n# 5. Restart application\n```\n\n#### Option 2: Investigation & Fix (if issues can be resolved)\n1. [ ] Identify root cause\n2. [ ] Document issue\n3. [ ] Develop fix\n4. [ ] Test fix\n5. [ ] Apply fix\n6. [ ] Verify resolution\n7. [ ] Update this checklist\n\n#### Option 3: Partial Rollback (if only code has issues)\n```bash\n# Revert only code changes, keep database schema\ngit checkout src/\nnpm run build\n# Redeploy\n```\n\n---\n\n## Post-Rollback\nIf rollback was necessary:\n- [ ] Document failure cause\n- [ ] Update migration files if needed\n- [ ] Root cause analysis completed\n- [ ] Fix identified and tested\n- [ ] Plan for re-deployment scheduled\n\n---\n\n## Success Criteria\n\n**Migration is successful if ALL of the following are true:**\n\n✅ **Database**\n- [ ] All SQL migrations executed without errors\n- [ ] `transaction_line_id` column exists and is populated\n- [ ] Foreign key constraints in place\n- [ ] New indexes created\n- [ ] View `v_transaction_line_items_with_context` accessible\n- [ ] Document associations accept 'transaction_line_items' entity type\n\n✅ **Code**\n- [ ] Application builds without errors\n- [ ] No TypeScript compilation errors\n- [ ] No ESLint violations\n- [ ] Application starts without errors\n\n✅ **Functionality**\n- [ ] Can attach documents to transaction line items\n- [ ] Document count displays correctly\n- [ ] Can remove documents\n- [ ] Multiple documents per line item works\n- [ ] Existing data preserved\n- [ ] No data loss\n\n✅ **Performance**\n- [ ] Page load times acceptable (< 2 seconds)\n- [ ] No N+1 query problems\n- [ ] Document operations fast (< 1 second)\n- [ ] No excessive memory usage\n\n✅ **Stability**\n- [ ] No critical errors in logs\n- [ ] No unexpected exceptions\n- [ ] All browsers work correctly\n- [ ] Mobile views responsive\n\n---\n\n## Deployment Timeline\n\n```\nT+0min:   Database migration 1 execution\nT+2min:   Verify migration 1\nT+5min:   Database migration 2 execution\nT+7min:   Verify migration 2\nT+10min:  Code build and deployment start\nT+20min:  Code deployment complete\nT+25min:  Application verification\nT+55min:  Full testing cycle complete\nT+60min:  Sign-off\n\nTotal: ~60 minutes\n```\n\n---\n\n## Contacts & Escalation\n\n**For Database Issues:**\n- Database Admin: _______________\n- Backup: _______________\n\n**For Code/Application Issues:**\n- Tech Lead: _______________\n- Backup: _______________\n\n**For Testing Issues:**\n- QA Lead: _______________\n- Backup: _______________\n\n---\n\n## Final Sign-Off\n\n**Deployment Approved By:**\n- Name: _______________\n- Title: _______________\n- Date: _______________\n- Time: _______________\n\n**Actual Deployment Performed By:**\n- Name: _______________\n- Date: _______________\n- Time Started: _______________\n- Time Completed: _______________\n- Result: [ ] Success [ ] Partial Success [ ] Failure\n\n**Issues Encountered:**\n\n_______________________________________________________________\n\n**Resolution:**\n\n_______________________________________________________________\n\n**Notes:**\n\n_______________________________________________________________\n\n---\n\n**Document Version:** 1.0  \n**Last Updated:** 2025-10-19  \n**Status:** Ready for Use\n"
antml:parameter>
</invoke>