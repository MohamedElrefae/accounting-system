# Complete Warp AI Agent Prompt: Transaction Entry UI Transformation

**Project:** Construction Accounting System (React + TypeScript + Supabase)  
**Date:** October 25, 2025  
**Version:** Final with org_id inheritance, Line Edit & Delete

---

## Context & Background

You are modifying an existing React/TypeScript accounting application that manages financial transactions using a header-lines (master-detail) data model with Supabase PostgreSQL tables.

### Current Implementation
- **Section 1:** Transaction header form at top
- **Section 2:** Well-designed unified CRUD form (from single-row entry days)
  - Currently titled "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©" (Edit Transaction)
  - Used for transaction header editing
- **Section 3:** Basic, poorly-designed form for adding transaction lines

### Target Implementation
- Reuse Section 2's proven form design for BOTH header AND lines entry
- Implement progressive disclosure pattern
- After header submission, convert header to read-only with edit button
- Repurpose Section 2 to add transaction lines (change title to "Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©")
- **Section 2 in LINE_MODE must be wired to transaction_lines table with ALL 11 visible columns**
- Eliminate Section 3 entirely
- Handle localStorage defaults for org_id and project_id with user override capability
- **Support complete CRUD: Add, Edit, Delete operations for lines**

---

## Database Schema

### Transactions Table (Header)

**Key Fields:**
- `id`: uuid (PK, auto-generated)
- `entry_number`: text (auto-generated by trigger `tr_tx_set_entry_number`)
- `entry_date`: date (required)
- `description`: text (required, English)
- `description_ar`: text (Arabic description, optional)
- `reference_number`: text (optional)
- `notes`: text (optional)
- `notes_ar`: text (Arabic notes, optional)
- `project_id`: uuid (FK to projects, DEFAULT from localStorage, user-editable)
- `org_id`: uuid (FK to organizations, DEFAULT from localStorage, user-editable)
- `approval_status`: text (draft/submitted/approved/rejected/revision_requested/cancelled)
- `is_posted`: boolean (default false)
- `total_debits`: numeric(18,4) (default 0, auto-calculated by triggers)
- `total_credits`: numeric(18,4) (default 0, auto-calculated by triggers)
- `line_items_count`: integer (default 0, auto-calculated by triggers)
- `has_line_items`: boolean (default false, auto-calculated by triggers)
- `created_at`: timestamptz (auto)
- `updated_at`: timestamptz (auto)

**Critical Constraints:**
- `trg_tx_must_have_lines`: Transaction must have at least one line
- `trg_tx_balanced_tx`: total_debits must equal total_credits
- `trg_guard_tx_requires_lines`: Ensures line items exist before posting
- All deferred triggers execute at end of transaction

**Business Rules:**
- Entry number is auto-generated (don't provide in form)
- org_id and project_id DEFAULT values loaded from localStorage
- User can see defaults and edit if needed (maximum flexibility)
- Totals are auto-calculated by triggers (don't provide in form)
- Transaction starts in 'draft' approval_status
- Cannot be posted until approved

### Transaction_Lines Table

**ALL FIELDS FOR SECTION 2 LINE_MODE FORM:**

**Required Field:**
- `account_id`: uuid NOT NULL (FK to accounts, dropdown, required)

**Amount Fields (NOT NULL with defaults, XOR constraint):**
- `debit_amount`: numeric(15,4) NOT NULL DEFAULT 0 (number input)
- `credit_amount`: numeric(15,4) NOT NULL DEFAULT 0 (number input)
  - **CRITICAL:** Either debit > 0 OR credit > 0 (never both, never neither)

**Description Field (Optional):**
- `description`: text NULL (optional line-specific notes)

**Data Isolation & Cost Tracking Fields (All optional, inherit from header, user can override):**
- `org_id`: uuid NULL (FK to organizations, **CRITICAL for data isolation**, inherited from header, user can override)
  - **IMPORTANT:** While trigger auto-syncs, allow user override for inter-company transactions
- `project_id`: uuid NULL (FK to projects, defaults from header, dropdown, user-editable)
- `cost_center_id`: uuid NULL (FK to cost_centers, dropdown, optional)
- `work_item_id`: uuid NULL (FK to work_items, dropdown, optional)
- `analysis_work_item_id`: uuid NULL (FK to analysis_work_items, dropdown, optional)
- `classification_id`: uuid NULL (FK to transaction_classification, dropdown, optional)
- `sub_tree_id`: uuid NULL (FK to sub_tree, dropdown, optional)

**Auto-Managed Fields (Don't show in form):**
- `id`: uuid (PK, auto-generated)
- `transaction_id`: uuid NOT NULL (FK, from state, hidden field)
- `line_no`: integer NOT NULL (auto-calculated: max existing + 1, hidden field)
- `created_at`: timestamptz (auto-generated)

**Critical Constraints:**
- `uk_tl_tx_line`: UNIQUE(transaction_id, line_no)
- `chk_tl_one_side_positive`: Either debit > 0 and credit = 0, OR credit > 0 and debit = 0
- `chk_tl_amounts_non_negative`: Both amounts must be >= 0
- `trg_tx_balanced_lines`: Triggers balance check on parent transaction
- `fn_check_line_account_postable`: Account must be postable

**Business Rules:**
- Line numbers start at 1 and increment (auto-calculated)
- Either debit OR credit must have a value (not both, not neither)
- org_id is auto-synced from transaction header but user can override
- project_id INHERITED from header but user can override
- All other cost tracking fields are optional
- Adding/updating/deleting lines triggers parent transaction total recalculation

---

## localStorage Defaults & User Override Pattern

### Three-Tier Inheritance System

**Tier 1: Application Defaults (localStorage)**
```typescript
localStorage.getItem('default_org_id')      // â†’ "org-uuid"
localStorage.getItem('default_project_id')  // â†’ "proj-uuid"
```

**Tier 2: Transaction Header (User Can Override)**
1. Header form pre-fills org_id dropdown with localStorage default
2. Header form pre-fills project_id dropdown with localStorage default
3. User can SEE the defaults and CHANGE them if needed
4. When header is saved, uses user's selected values (defaults or modified)
5. Stores final org_id and project_id in transactions table

**Tier 3: Transaction Lines (Inherit from Header, User Can Override)**
1. Line form pre-fills org_id from HEADER's org_id
2. Line form pre-fills project_id from HEADER's project_id
3. User can accept inherited value or select different org/project
4. Maximum flexibility for multi-project and inter-company transactions

### Implementation Pattern

```typescript
// On component mount or new transaction
useEffect(() => {
  const defaultOrgId = localStorage.getItem('default_org_id');
  const defaultProjectId = localStorage.getItem('default_project_id');
  
  // Pre-fill header form
  if (formMode.mode === 'HEADER_MODE' && !formMode.transactionId) {
    setFormData({
      ...formData,
      org_id: defaultOrgId,
      project_id: defaultProjectId
    });
  }
}, []);

// When switching to LINE_MODE after header save
useEffect(() => {
  if (formMode.mode === 'LINE_MODE' && transactionHeader) {
    // Pre-fill line form with header's org_id and project_id
    setLineFormData({
      ...lineFormData,
      org_id: transactionHeader.org_id,        // Inherited default
      project_id: transactionHeader.project_id // Inherited default
      // User can change dropdowns to different org/project if needed
    });
  }
}, [formMode.mode, transactionHeader]);
```

---

## Section 2 Form Wiring for LINE_MODE

### When formMode.mode === 'LINE_MODE', Section 2 form must include:

**11 VISIBLE USER FIELDS:**

**1. Account (Ø§Ù„Ø­Ø³Ø§Ø¨) - REQUIRED**
- Type: Dropdown (select)
- Field: `account_id`
- Options: Active, postable accounts from accounts table
- Display: code + name_ar (e.g., "1010 - Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©")
- Validation: Required, must exist

**2. Debit Amount (Ù…Ø¯ÙŠÙ†)**
- Type: Number input
- Field: `debit_amount`
- Default: 0
- Validation: >= 0, max 4 decimals
- Logic: If > 0, then credit must = 0

**3. Credit Amount (Ø¯Ø§Ø¦Ù†)**
- Type: Number input
- Field: `credit_amount`
- Default: 0
- Validation: >= 0, max 4 decimals
- Logic: If > 0, then debit must = 0

**Validation Error Messages:**
- Both > 0: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù† Ù…Ø¹Ø§Ù‹"
- Both = 0: "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¯Ø§Ø¦Ù†"

**4. Description (Ø§Ù„Ø¨ÙŠØ§Ù†)**
- Type: Text input or textarea
- Field: `description`
- Optional: Line-specific notes
- Different from header description

**COST TRACKING FIELDS (All optional, show in expandable section):**

**5. Organization (Ø§Ù„Ù…Ø¤Ø³Ø³Ø©) - INHERITED DEFAULT, CRITICAL FOR DATA ISOLATION**
- Type: Dropdown (select)
- Field: `org_id`
- Default: Inherited from header's org_id
- User can change: Yes (maximum flexibility for inter-company transactions)
- Show ğŸ”— icon to indicate inherited value
- Nullable: Yes

**6. Project (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹) - INHERITED DEFAULT**
- Type: Dropdown (select)
- Field: `project_id`
- Default: Inherited from header's project_id
- User can change: Yes (maximum flexibility)
- Show ğŸ”— icon to indicate inherited value
- Nullable: Yes

**7. Cost Center (Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©)**
- Type: Dropdown (select)
- Field: `cost_center_id`
- Optional: Yes
- Options: Active cost centers

**8. Work Item (Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù…Ù„)**
- Type: Dropdown (select)
- Field: `work_item_id`
- Optional: Yes
- Options: Active work items

**9. Analysis Work Item (Ø¨Ù†Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„)**
- Type: Dropdown (select)
- Field: `analysis_work_item_id`
- Optional: Yes
- Options: Active analysis work items

**10. Classification (Ø§Ù„ØªØµÙ†ÙŠÙ)**
- Type: Dropdown (select)
- Field: `classification_id`
- Optional: Yes
- Options: Transaction classifications

**11. Sub Tree (Ø§Ù„Ø´Ø¬Ø±Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©)**
- Type: Dropdown (select)
- Field: `sub_tree_id`
- Optional: Yes
- Options: Active sub trees

**HIDDEN FIELDS (Auto-filled, don't show in UI):**
- `transaction_id` (from formMode.transactionId state)
- `line_no` (auto-calculated before insert: max existing + 1)

**DON'T SHOW (Integration fields, usually null):**
- `source_module`
- `source_document_id`
- `source_document_line_id`

### Form Layout Recommendation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Add Transaction Line)                   â”‚
â”‚ OR                                                           â”‚
â”‚ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Edit Transaction Line) - when editing   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ [Required Section]                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Account* (Ø§Ù„Ø­Ø³Ø§Ø¨)        [Dropdown â–¼]               â”‚    â”‚
â”‚ â”‚ Debit (Ù…Ø¯ÙŠÙ†)             [0.00________]             â”‚    â”‚
â”‚ â”‚ Credit (Ø¯Ø§Ø¦Ù†)            [0.00________]             â”‚    â”‚
â”‚ â”‚ Description (Ø§Ù„Ø¨ÙŠØ§Ù†)     [___________________]       â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚ [Data Isolation & Cost Tracking] âŠ• Expand/Collapse          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Organization* (Ø§Ù„Ù…Ø¤Ø³Ø³Ø©) ğŸ”—                           â”‚    â”‚
â”‚ â”‚ [Inherited from header â–¼]                            â”‚    â”‚
â”‚ â”‚ â†‘ Inherited (can override for inter-company txns)    â”‚    â”‚
â”‚ â”‚                                                       â”‚    â”‚
â”‚ â”‚ Project (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹) ğŸ”—                                 â”‚    â”‚
â”‚ â”‚ [Inherited from header â–¼]                            â”‚    â”‚
â”‚ â”‚ â†‘ Inherited (can change per line)                    â”‚    â”‚
â”‚ â”‚                                                       â”‚    â”‚
â”‚ â”‚ Cost Center (Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©) [Select... â–¼]           â”‚    â”‚
â”‚ â”‚ Work Item (Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ù…Ù„)     [Select... â–¼]            â”‚    â”‚
â”‚ â”‚ Analysis Item (Ø¨Ù†Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„) [Select... â–¼]          â”‚    â”‚
â”‚ â”‚ Classification (Ø§Ù„ØªØµÙ†ÙŠÙ)  [Select... â–¼]            â”‚    â”‚
â”‚ â”‚ Sub Tree (Ø§Ù„Ø´Ø¬Ø±Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ©) [Select... â–¼]            â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚                      [Ø¥Ù„ØºØ§Ø¡] [Ø¥Ø¶Ø§ÙØ© âœ“] (when adding)        â”‚
â”‚                      [Ø¥Ù„ØºØ§Ø¡] [ØªØ­Ø¯ÙŠØ« âœ“] (when editing)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete CRUD Operations

### 1. ADD OPERATION

**Workflow:**
1. User fills form with inherited org_id and project_id
2. User can override org_id or project_id if needed
3. Enter account, debit/credit, description
4. Optionally fill cost tracking fields
5. Click "Ø¥Ø¶Ø§ÙØ©" (Add) button
6. Validate debit XOR credit
7. Calculate next line_no
8. INSERT into transaction_lines
9. Database triggers auto-update parent transaction totals
10. Fetch updated transaction totals
11. Add line to visible lines list
12. Reset form BUT keep inherited org_id and project_id defaults
13. Keep form open for additional lines
14. Display success message: "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø·Ø± Ø¨Ù†Ø¬Ø§Ø­"

**Supabase Query:**

```typescript
// Get next line number
const { data: existingLines } = await supabase
  .from('transaction_lines')
  .select('line_no')
  .eq('transaction_id', transactionId)
  .order('line_no', { ascending: false })
  .limit(1);

const nextLineNo = existingLines?.length > 0 
  ? existingLines[0].line_no + 1 
  : 1;

// Insert line with ALL applicable fields
const { data: newLine, error } = await supabase
  .from('transaction_lines')
  .insert({
    transaction_id: transactionId,
    line_no: nextLineNo,
    account_id: formData.account_id,  // REQUIRED
    debit_amount: formData.debit_amount || 0,
    credit_amount: formData.credit_amount || 0,
    description: formData.description || null,
    org_id: formData.org_id || null,  // Can differ from header
    project_id: formData.project_id || null,  // Can differ from header
    cost_center_id: formData.cost_center_id || null,
    work_item_id: formData.work_item_id || null,
    analysis_work_item_id: formData.analysis_work_item_id || null,
    classification_id: formData.classification_id || null,
    sub_tree_id: formData.sub_tree_id || null
    // Don't include: id, created_at (auto-generated)
  })
  .select()
  .single();

if (!error) {
  await refreshTransactionTotals(transactionId);
  await fetchTransactionLines(transactionId);
  resetLineFormWithInheritedDefaults();  // Keeps org_id and project_id
  showSuccess('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø·Ø± Ø¨Ù†Ø¬Ø§Ø­');
}
```

### 2. EDIT OPERATION

**Workflow:**
1. User clicks Edit (âœï¸) button on existing line in summary table
2. Load line data into form with ALL 11 fields
3. Form title changes to "ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©" (Edit Transaction Line)
4. Save button text changes to "ØªØ­Ø¯ÙŠØ«" (Update)
5. Store line id in `editingLineId` state
6. User modifies fields as needed (can change org_id, project_id, etc.)
7. Click "ØªØ­Ø¯ÙŠØ«" (Update) button
8. Validate changes (debit XOR credit, etc.)
9. UPDATE transaction_lines WHERE id = editingLineId
10. Database triggers recalculate parent transaction totals
11. Fetch updated transaction and lines
12. Reset form to ADD mode (clear editingLineId)
13. Change form title back to "Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©"
14. Change button text back to "Ø¥Ø¶Ø§ÙØ©"
15. Display success message: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø·Ø± Ø¨Ù†Ø¬Ø§Ø­"

**Supabase Queries:**

```typescript
// Load line for editing
const handleLineEdit = async (lineId: string) => {
  const { data: line, error } = await supabase
    .from('transaction_lines')
    .select('*')
    .eq('id', lineId)
    .single();
  
  if (line && !error) {
    // Populate form with ALL 11 fields
    setLineFormData({
      account_id: line.account_id,
      debit_amount: line.debit_amount,
      credit_amount: line.credit_amount,
      description: line.description || '',
      org_id: line.org_id || '',  // May differ from header
      project_id: line.project_id || '',  // May differ from header
      cost_center_id: line.cost_center_id || '',
      work_item_id: line.work_item_id || '',
      analysis_work_item_id: line.analysis_work_item_id || '',
      classification_id: line.classification_id || '',
      sub_tree_id: line.sub_tree_id || ''
    });
    
    // Set edit mode
    setEditingLineId(lineId);
    setFormMode({ ...formMode, isEditing: true });
    setFormTitle('ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
    setButtonText('ØªØ­Ø¯ÙŠØ«');
  }
};

// Update line
const handleLineUpdate = async (lineId: string, formData: TransactionLineFormData) => {
  // Validate
  const validationError = validateLineAmounts(formData.debit_amount, formData.credit_amount);
  if (validationError) {
    setError(validationError);
    return;
  }
  
  const { error } = await supabase
    .from('transaction_lines')
    .update({
      account_id: formData.account_id,
      debit_amount: formData.debit_amount || 0,
      credit_amount: formData.credit_amount || 0,
      description: formData.description || null,
      org_id: formData.org_id || null,  // User can override
      project_id: formData.project_id || null,  // User can override
      cost_center_id: formData.cost_center_id || null,
      work_item_id: formData.work_item_id || null,
      analysis_work_item_id: formData.analysis_work_item_id || null,
      classification_id: formData.classification_id || null,
      sub_tree_id: formData.sub_tree_id || null
    })
    .eq('id', lineId);
  
  if (!error) {
    await refreshTransactionTotals(transactionId);
    await fetchTransactionLines(transactionId);
    
    // Reset to ADD mode
    setEditingLineId(null);
    setFormMode({ ...formMode, isEditing: false });
    resetLineFormWithInheritedDefaults();
    setFormTitle('Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
    setButtonText('Ø¥Ø¶Ø§ÙØ©');
    
    showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø·Ø± Ø¨Ù†Ø¬Ø§Ø­');
  }
};
```

### 3. DELETE OPERATION

**Workflow:**
1. User clicks Delete (ğŸ—‘ï¸) button on line
2. Check if this is the last line
   - If yes: Show error "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù‚ÙŠØ¯ Ø¹Ù„Ù‰ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"
   - If no: Continue
3. Show confirmation dialog: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŸ"
4. User can click Cancel or Delete
5. If Cancel: Close dialog, do nothing
6. If Delete:
   - DELETE FROM transaction_lines WHERE id = lineId
   - Database triggers automatically update parent transaction totals
   - Fetch updated transaction and lines
   - Refresh lines summary display
   - Display success message: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ø¨Ù†Ø¬Ø§Ø­"

**Supabase Query:**

```typescript
const handleLineDelete = async (lineId: string) => {
  // Check if last line (prevent deletion)
  if (transactionLines.length === 1) {
    showError('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù‚ÙŠØ¯ Ø¹Ù„Ù‰ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    return;
  }
  
  // Show confirmation dialog
  const confirmed = await showConfirmDialog(
    'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŸ',
    'warning'
  );
  
  if (!confirmed) return;
  
  // Delete
  const { error } = await supabase
    .from('transaction_lines')
    .delete()
    .eq('id', lineId)
    .eq('transaction_id', transactionId);  // Extra safety
  
  if (!error) {
    // Refresh transaction totals (triggers updated them)
    await refreshTransactionTotals(transactionId);
    
    // Refresh lines list
    await fetchTransactionLines(transactionId);
    
    // Success message
    showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ø¨Ù†Ø¬Ø§Ø­');
  } else {
    showError('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
  }
};
```

### Helper Functions

```typescript
// Refresh transaction totals after line changes
const refreshTransactionTotals = async (transactionId: string) => {
  const { data: transaction } = await supabase
    .from('transactions')
    .select('total_debits, total_credits, line_items_count, has_line_items')
    .eq('id', transactionId)
    .single();
  
  if (transaction) {
    setCurrentTotals({
      totalDebits: transaction.total_debits,
      totalCredits: transaction.total_credits,
      balance: transaction.total_debits - transaction.total_credits,
      isBalanced: transaction.total_debits === transaction.total_credits
    });
  }
};

// Fetch all lines with related data
const fetchTransactionLines = async (transactionId: string) => {
  const { data: lines } = await supabase
    .from('transaction_lines')
    .select(`
      *,
      account:accounts(id, code, name, name_ar),
      project:projects(id, name, name_ar),
      organization:organizations(id, name, name_ar),
      cost_center:cost_centers(id, code, name, name_ar),
      work_item:work_items(id, code, name, name_ar),
      analysis_work_item:analysis_work_items(id, code, name, name_ar),
      classification:transaction_classification(id, name, name_ar),
      sub_tree:sub_tree(id, code, name, name_ar)
    `)
    .eq('transaction_id', transactionId)
    .order('line_no', { ascending: true });
  
  if (lines) {
    setTransactionLines(lines);
  }
};

// Reset form but keep inherited defaults
const resetLineFormWithInheritedDefaults = () => {
  setLineFormData({
    account_id: '',
    debit_amount: 0,
    credit_amount: 0,
    description: '',
    org_id: transactionHeader?.org_id || '',  // Inherit from header
    project_id: transactionHeader?.project_id || '',  // Inherit from header
    cost_center_id: '',
    work_item_id: '',
    analysis_work_item_id: '',
    classification_id: '',
    sub_tree_id: ''
  });
};

// Validate line amounts (XOR constraint)
const validateLineAmounts = (debit: number, credit: number): string | null => {
  if (debit === 0 && credit === 0) {
    return 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¯Ø§Ø¦Ù†';
  }
  if (debit > 0 && credit > 0) {
    return 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù† Ù…Ø¹Ø§Ù‹';
  }
  if (debit < 0 || credit < 0) {
    return 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨Ø§Ù‹';
  }
  return null;
};
```

---

## Lines Summary Table Structure

### Display Requirements

**Columns (RTL layout, right to left):**
- Actions (Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª): Edit and Delete buttons
- Cost Center (Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©): Code/name if assigned
- Project (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹): Name (show if different from header)
- Organization (Ø§Ù„Ù…Ø¤Ø³Ø³Ø©): Name (show if different from header)
- Credit (Ø¯Ø§Ø¦Ù†): Formatted amount
- Debit (Ù…Ø¯ÙŠÙ†): Formatted amount
- Account (Ø§Ù„Ø­Ø³Ø§Ø¨): Code + name_ar
- Line # (Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø±)

**Footer Row:**
- TOTALS: Total Debits, Total Credits
- Balance indicator: Green checkmark âœ“ if balanced, Red X âŒ if not balanced

**Example:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transaction Lines Summary                                  â”‚
â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¤
â”‚ âš¡ â”‚  CC  â”‚ Proj â”‚ Org  â”‚ Crdt â”‚ Debt â”‚ Account    â”‚  # â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚âœï¸ğŸ—‘ï¸â”‚ CC-01â”‚ PrjA â”‚ Org1 â”‚   0  â”‚ 1000 â”‚ 1010-Cash  â”‚  1 â”‚
â”‚âœï¸ğŸ—‘ï¸â”‚ CC-02â”‚ PrjA â”‚ Org1 â”‚ 1000 â”‚   0  â”‚ 2010-AP    â”‚  2 â”‚
â”‚âœï¸ğŸ—‘ï¸â”‚ CC-01â”‚ PrjB â”‚ Org2 â”‚  500 â”‚   0  â”‚ 3010-AR    â”‚  3 â”‚
â”œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¤
â”‚                         TOTALS:  1500    1000              â”‚
â”‚                                Balance: -500  âŒ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Action Buttons

**Edit Button (âœï¸):**
- Icon: Pencil (âœï¸)
- Color: Blue (#3B82F6 or similar info color)
- Tooltip: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø·Ø±" (Edit Line)
- Position: First button in Actions column
- Functionality: Load line data into form for editing
- Disabled when: `transaction.is_posted === true`

**Delete Button (ğŸ—‘ï¸):**
- Icon: Trash (ğŸ—‘ï¸)
- Color: Red (#EF4444 or similar danger color)
- Tooltip: "Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø±" (Delete Line)
- Position: Second button in Actions column  
- Functionality: Delete line after confirmation
- Disabled when: `transaction.is_posted === true`

**Button States:**

When NOT posted (`is_posted === false`):
- Edit: Blue, clickable, normal cursor
- Delete: Red, clickable, normal cursor

When posted (`is_posted === true`):
- Edit: Gray, not clickable, cursor not-allowed
- Delete: Gray, not clickable, cursor not-allowed
- Tooltip: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø§Ù„Ù‚ÙŠØ¯ Ù…Ø±Ø­Ù„" (Cannot edit - Transaction is posted)

---

## TypeScript Interfaces

```typescript
// Form mode state
interface FormMode {
  mode: 'HEADER_MODE' | 'LINE_MODE';
  transactionId: string | null;
  isHeaderReadOnly: boolean;
  isEditing: boolean;  // true when editing line, false when adding
  editingLineId: string | null;  // ID of line being edited
}

// Transaction header (matches transactions table)
interface Transaction {
  id: string;
  entry_number: string;  // Auto-generated
  entry_date: string;    // ISO date string
  description: string;
  description_ar?: string | null;
  reference_number?: string | null;
  notes?: string | null;
  notes_ar?: string | null;
  project_id?: string | null;  // From localStorage default, user-editable
  org_id: string;  // From localStorage default, user-editable
  approval_status: 'draft' | 'submitted' | 'approved' | 'rejected' | 'revision_requested' | 'cancelled';
  is_posted: boolean;
  posted_at?: string | null;
  posted_by?: string | null;
  has_line_items: boolean;  // Auto-calculated
  line_items_count: number;  // Auto-calculated
  total_debits: number;  // Auto-calculated
  total_credits: number;  // Auto-calculated
  created_at: string;
  updated_at: string;
}

// Transaction line - ALL FIELDS (matches transaction_lines table)
interface TransactionLine {
  // Primary key
  id: string;
  
  // Foreign keys
  transaction_id: string;
  account_id: string;  // REQUIRED
  
  // Line identification
  line_no: number;  // Auto-calculated
  
  // Amounts (XOR constraint)
  debit_amount: number;  // NOT NULL DEFAULT 0
  credit_amount: number;  // NOT NULL DEFAULT 0
  
  // Description
  description?: string | null;  // Optional line notes
  
  // Data isolation & cost tracking (all optional)
  org_id?: string | null;  // Inherited from header, user can override
  project_id?: string | null;  // Inherited from header, user can override
  cost_center_id?: string | null;
  work_item_id?: string | null;
  analysis_work_item_id?: string | null;
  classification_id?: string | null;
  sub_tree_id?: string | null;
  
  // Auto-managed
  created_at: string;
  
  // Source tracking (usually null for manual entry)
  source_module?: string | null;
  source_document_id?: string | null;
  source_document_line_id?: string | null;
}

// Form data for header (what user enters)
interface TransactionHeaderFormData {
  entry_date: string;
  description: string;
  description_ar?: string;
  reference_number?: string;
  notes?: string;
  notes_ar?: string;
  project_id?: string;  // Pre-filled from localStorage, user can edit
  org_id?: string;  // Pre-filled from localStorage, user can edit
}

// Form data for line (what user enters) - ALL FIELDS
interface TransactionLineFormData {
  account_id: string;  // REQUIRED
  debit_amount: number;  // Default 0
  credit_amount: number;  // Default 0
  description?: string;  // Optional
  org_id?: string;  // Inherited from header, user can change
  project_id?: string;  // Inherited from header, user can change
  cost_center_id?: string;  // Optional
  work_item_id?: string;  // Optional
  analysis_work_item_id?: string;  // Optional
  classification_id?: string;  // Optional
  sub_tree_id?: string;  // Optional
}

// localStorage defaults
interface DefaultSettings {
  org_id: string;
  project_id: string;
}

// For lines summary totals
interface LinesSummaryTotals {
  totalDebits: number;
  totalCredits: number;
  balance: number;
  isBalanced: boolean;
}

// Component state
const [formMode, setFormMode] = useState<FormMode>({
  mode: 'HEADER_MODE',
  transactionId: null,
  isHeaderReadOnly: false,
  isEditing: false,
  editingLineId: null
});

const [lineFormData, setLineFormData] = useState<TransactionLineFormData>({
  account_id: '',
  debit_amount: 0,
  credit_amount: 0,
  description: '',
  org_id: '',  // Will be inherited from header
  project_id: '',  // Will be inherited from header
  cost_center_id: '',
  work_item_id: '',
  analysis_work_item_id: '',
  classification_id: '',
  sub_tree_id: ''
});
```

---

## Validation & Business Rules

### Header Validation

âœ“ `entry_date`: Required, valid date  
âœ“ `description`: Required, minimum 3 characters  
âœ“ `org_id`: Pre-filled from localStorage, user can change, must be valid  
âœ“ `project_id`: Optional, if set must be valid  
âœ“ Cannot edit if `is_posted === true`

### Line Validation

âœ“ `account_id`: REQUIRED, must be postable  
âœ“ Amounts: `(debit > 0 XOR credit > 0)` - NEVER both, NEVER neither  
âœ“ Amounts: Must be >= 0, max 4 decimals  
âœ“ `description`: Optional  
âœ“ `org_id`: Inherited from header, user can override  
âœ“ `project_id`: Inherited from header, user can override  
âœ“ All other cost tracking: Optional  
âœ“ Cannot add/edit/delete if parent transaction is posted

### Transaction Validation

âœ“ Must have at least 1 line (enforced by trigger)  
âœ“ Total debits must equal total credits (enforced by trigger)  
âœ“ All lines must have postable accounts (enforced by trigger)  
âœ“ Cannot post unless balanced and approved

### UI Validation Messages (Arabic)

- Empty entry_date: "Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø·Ù„ÙˆØ¨"
- Empty description: "Ø§Ù„ÙˆØµÙ Ù…Ø·Ù„ÙˆØ¨"
- Empty account: "Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø·Ù„ÙˆØ¨"
- Both amounts > 0: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† ÙˆØ§Ù„Ø¯Ø§Ø¦Ù† Ù…Ø¹Ø§Ù‹"
- Both amounts = 0: "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¯Ø§Ø¦Ù†"
- Negative amount: "Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨Ø§Ù‹"
- Cannot edit posted: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø§Ù„Ù‚ÙŠØ¯ Ù…Ø±Ø­Ù„"
- Cannot delete last line: "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù‚ÙŠØ¯ Ø¹Ù„Ù‰ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"

---

## Implementation Steps

### Phase 1: localStorage & Mode Switching (Critical)

1. Create `loadDefaultSettings()` function
2. Load defaults on component mount
3. Add `formMode` state management
4. Pre-fill header form with localStorage defaults
5. Implement HEADER_MODE form submission
6. Store header data and switch to LINE_MODE

### Phase 2: Section 2 LINE_MODE Wiring (Core)

7. Add ALL 11 visible fields to LINE_MODE form:
   - account_id (required dropdown)
   - debit_amount (number input)
   - credit_amount (number input)
   - description (text input, optional)
   - org_id (dropdown, inherited from header, can override)
   - project_id (dropdown, inherited from header, can override)
   - cost_center_id (optional dropdown)
   - work_item_id (optional dropdown)
   - analysis_work_item_id (optional dropdown)
   - classification_id (optional dropdown)
   - sub_tree_id (optional dropdown)

8. Add hidden fields: transaction_id, line_no
9. Implement debit XOR credit validation
10. Create `handleLineSubmit` with ALL fields

### Phase 3: Dropdown Data Fetching

11. Fetch accounts (active, postable only)
12. Fetch organizations (active only)
13. Fetch projects (active only)
14. Fetch cost_centers (active only)
15. Fetch work_items (active only)
16. Fetch analysis_work_items (active only)
17. Fetch transaction_classification (active only)
18. Fetch sub_tree (active only)
19. Cache all dropdown data in state

### Phase 4: UX Enhancements

20. Create expandable "Data Isolation & Cost Tracking" section
21. Implement expand/collapse toggle
22. Show inherited org_id and project_id with ğŸ”— indicator
23. Add loading states for all async operations
24. Display Arabic error messages
25. Implement ReadOnlyHeaderCard with org & project names

### Phase 5: Lines Summary Table

26. Create LinesSummaryTable component
27. Show ALL columns including org and project
28. Calculate and display totals
29. Add balance indicator (green checkmark/red X)
30. Add Edit button (âœï¸) to each row
31. Add Delete button (ğŸ—‘ï¸) to each row

### Phase 6: Edit Functionality

32. Create `handleLineEdit` function
33. Load line data into form (all 11 fields)
34. Change form title to "ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©"
35. Change button text to "ØªØ­Ø¯ÙŠØ«"
36. Store `editingLineId` in state
37. Create `handleLineUpdate` function
38. Reset form to ADD mode after update

### Phase 7: Delete Functionality

39. Create `handleLineDelete` function
40. Add check to prevent deletion of last line
41. Show confirmation dialog in Arabic
42. Handle delete confirmation/cancellation
43. Refresh totals and lines after deletion

### Phase 8: Testing

44. Test localStorage defaults pre-fill
45. Test user override of org and project at header level
46. Test org_id and project_id inheritance to lines
47. Test per-line org_id override (inter-company transactions)
48. Test per-line project_id override
49. Test ALL optional cost tracking fields
50. Test debit XOR credit validation
51. Test line submission with all fields
52. Test line editing (all 11 fields load correctly)
53. Test line deletion with confirmation
54. Test prevention of last line deletion
55. Test form reset keeps inherited defaults
56. Test multi-project transaction scenario
57. Test RTL layout and Arabic labels
58. Test button states (enabled/disabled when posted)
59. Test totals recalculation after add/edit/delete
60. Test balance indicator (green/red)

---

## Critical Success Factors

âœ… **org_id visible** in expandable section for transparency  
âœ… **org_id inherited** from header by default  
âœ… **User can override** org_id for inter-company transactions  
âœ… **Both Edit and Delete** buttons present in Actions column  
âœ… **Edit loads ALL 11 fields** correctly into form  
âœ… **Delete shows confirmation** before removal  
âœ… **Prevent deletion** of last line  
âœ… **Refresh totals** after every operation (add/edit/delete)  
âœ… **Form mode switches** correctly (ADD/EDIT)  
âœ… **Arabic messages** for all operations  
âœ… **RTL layout** throughout interface  
âœ… **Disabled state** when transaction is posted  
âœ… **Maximum flexibility** for complex scenarios

---

## Output Requirements

Please provide complete, production-ready code including:

1. Modified Section 2 form component with:
   - HEADER_MODE fields
   - LINE_MODE fields (ALL 11 transaction_lines columns)
   - Mode switching logic
   - localStorage integration
   
2. ReadOnlyHeaderCard component showing org and project

3. LinesSummaryTable component with:
   - All cost tracking columns
   - Edit and Delete buttons
   - Totals and balance display
   
4. All CRUD functions:
   - `handleLineSubmit` (ADD with all fields)
   - `handleLineEdit` (load into form)
   - `handleLineUpdate` (UPDATE with all fields)
   - `handleLineDelete` (DELETE with confirmation)
   
5. Complete TypeScript interfaces with ALL fields

6. Supabase queries for:
   - All dropdowns (7 lookup tables)
   - Insert/Update/Delete operations
   - Fetching lines with joins
   
7. Validation functions including:
   - XOR constraint for debit/credit
   - Arabic error messages
   
8. State management for:
   - Form mode (ADD vs EDIT)
   - Defaults and inheritance
   - Editing line ID
   
9. UI components:
   - Expandable cost tracking section
   - Loading states and error handling
   - Arabic error messages
   - RTL support

10. Helper functions:
    - `refreshTransactionTotals()`
    - `fetchTransactionLines()`
    - `resetLineFormWithInheritedDefaults()`
    - `validateLineAmounts()`

---

## CRITICAL REMINDERS

âŒ **DON'T include in INSERT:**
- `entry_number` (auto-generated by trigger)
- `org_id` at header level (can be provided, but has trigger default)
- `total_debits`, `total_credits`, `line_items_count` (auto-calculated by triggers)
- `id`, `created_at` (auto-generated)

âœ… **DO include in line INSERT:**
- `transaction_id` (FK from state)
- `line_no` (calculate before insert: max + 1)
- `account_id` (required)
- `debit_amount` and `credit_amount` (with XOR validation)
- `org_id` and `project_id` (inherited, can be overridden)
- All optional cost tracking fields (if provided)

âš ï¸ **ALWAYS:**
- Check `is_posted` before allowing edits/deletes
- Validate debit XOR credit before INSERT/UPDATE
- Refresh transaction totals after any line change
- Handle all optional fields with `null` values
- Fetch all dropdown options for lookups
- Show inherited values with visual indicator (ğŸ”—)
- Keep form in RTL layout
- Display Arabic error messages

---

**END OF WARP AI AGENT PROMPT**

Please implement Section 2 form wired for transaction_lines table with ALL columns, localStorage defaults with user override capability, complete CRUD support (Add, Edit, Delete), org_id and project_id inheritance with per-line flexibility, and full cost tracking support.