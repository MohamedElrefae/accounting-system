# REVISED Response to Warp AI Clarifications: Transaction CRUD Implementation

**Date:** October 25, 2025  
**Project:** Construction Accounting System - Transaction Entry UI  
**CRITICAL:** Fields match database schema EXACTLY - no additional fields

---

## Clarification Responses

### A) Top Bar (Global Actions) - ‚úÖ CONFIRMED

**Core Actions:**
- ‚úÖ ÿ≠ŸÅÿ∏ ŸÖÿ≥ŸàÿØÿ© (Save Draft) - Enabled when balanced with ‚â•1 line
- ‚úÖ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ© (Submit for Review) - Enabled for draft status
- ‚úÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ (Cancel Submission) - Enabled for submitted status
- ‚úÖ ÿßÿπÿ™ŸÖÿßÿØ (Approve) - Enabled for reviewers on submitted transactions
- ‚úÖ ÿ•ÿ±ÿ¨ÿßÿπ ŸÑŸÑÿ™ÿπÿØŸäŸÑ (Return for Revision) - Enabled for reviewers with required reason
- ‚úÖ ÿ±ŸÅÿ∂ (Reject) - Enabled for reviewers with required reason
- ‚úÖ ÿ™ÿ±ÿ≠ŸäŸÑ (Post) - Enabled after approval, requires posting permission
- ‚úÖ ÿ≠ÿ∞ŸÅ (Delete) - Enabled for draft only, requires delete permission

**Header Templates:**
- ‚úÖ ÿ≠ŸÅÿ∏ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ±ÿ£ÿ≥ (Save Header Template) - Save current header as template
- ‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ±ÿ£ÿ≥ (Apply Header Template) - Load template values

**UX Controls:**
- ‚úÖ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ (Layout Settings) - Full modal for BOTH header AND line column management
- ‚úÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä (Restore Default) - Quick reset for layout
- ‚úÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑ (Save Layout) - Save current layout preferences

**State/Permission Gating:** ‚úÖ Confirmed
- All buttons appear/enabled based on:
  - `approval_status` (draft/submitted/approved/rejected/revision_requested/cancelled)
  - `is_posted` (boolean)
  - User permissions (create/update/delete/post/review/manage)

---

## B) Section 1 ‚Äî Transaction Header Fields

### ‚úÖ CONFIRMED Final Header Fields - EXACTLY MATCHING DATABASE SCHEMA

**Fields from `transactions` table ONLY:**

**Required Fields:**

1. **ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÇŸäÿØ** (`entry_date`)
   - Type: Date picker
   - Required: Yes
   - Database: `date NOT NULL`
   - Validation: Cannot be far future, check against period constraints
   - Default: Today's date

2. **ŸàÿµŸÅ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©** (`description`)
   - Type: Text input (English)
   - Required: Yes
   - Database: `text NOT NULL`
   - Validation: Minimum 3 characters

3. **ŸàÿµŸÅ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä** (`description_ar`)
   - Type: Text input (Arabic)
   - Required: No
   - Database: `text NULL`
   - Purpose: Arabic description

**Organization & Project (with localStorage defaults):**

4. **ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©** (`org_id`)
   - Type: Dropdown
   - Required: Yes (has default)
   - Database: `uuid FK to organizations`
   - Default: From localStorage `default_org_id` (user can change)
   - Filters: Affects all child dropdowns in lines
   - **CRITICAL for multi-tenant data isolation**

5. **ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ** (`project_id`)
   - Type: Dropdown
   - Required: No (optional)
   - Database: `uuid FK to projects, NULL`
   - Default: From localStorage `default_project_id` (user can change)
   - Filter: Filtered by selected ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©
   - Cascades to: Line defaults
   - Inheritance: Becomes default for new lines

**Additional Optional Fields:**

6. **ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±ÿ¨ÿπŸä** (`reference_number`)
   - Type: Text input
   - Required: No
   - Database: `text NULL`
   - Purpose: External reference (invoice number, PO number, etc.)

7. **ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™** (`notes`)
   - Type: Textarea (English)
   - Required: No
   - Database: `text NULL`
   - Purpose: Header-level notes

8. **ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿä** (`notes_ar`)
   - Type: Textarea (Arabic)
   - Required: No
   - Database: `text NULL`
   - Purpose: Arabic notes

**Auto-Generated Fields (READ ONLY - Don't show in form):**
- `entry_number` - Auto-generated by trigger `tr_tx_set_entry_number`
- `approval_status` - Managed by workflow buttons
- `is_posted` - Managed by ÿ™ÿ±ÿ≠ŸäŸÑ button
- `total_debits`, `total_credits`, `line_items_count` - Auto-calculated by triggers
- `has_line_items` - Auto-calculated by triggers
- `created_at`, `updated_at` - Auto-generated timestamps
- `posted_at`, `posted_by` - Set when posting
- `submitted_at`, `submitted_by` - Set when submitting
- `reviewed_at`, `reviewed_by` - Set when reviewing

### ‚ùå REMOVED - THESE FIELDS DO NOT EXIST IN TRANSACTIONS TABLE

**NOT in database schema, do NOT add to header:**
- ‚ùå `cost_center_id` - Does NOT exist in transactions table
- ‚ùå `classification_id` - Does NOT exist in transactions table
- ‚ùå `analysis_work_item_id` - Does NOT exist in transactions table
- ‚ùå `sub_tree_id` - Does NOT exist in transactions table
- ‚ùå `work_item_id` - Does NOT exist in transactions table

**These fields ONLY exist in `transaction_lines` table, not in header.**

### ‚úÖ FINAL HEADER FIELD COUNT: 8 Editable Fields

**Editable by user:**
1. entry_date (required)
2. description (required)
3. description_ar (optional)
4. org_id (required, default from localStorage)
5. project_id (optional, default from localStorage)
6. reference_number (optional)
7. notes (optional)
8. notes_ar (optional)

**Auto-managed (read-only):**
- entry_number
- approval_status
- is_posted
- all totals and counts
- all timestamps

---

## C) Section 2 ‚Äî Transaction Lines Editor

### ‚úÖ CONFIRMED Line Fields - EXACTLY MATCHING DATABASE SCHEMA

**Fields from `transaction_lines` table:**

**Required Fields:**

1. **ÿßŸÑÿ≠ÿ≥ÿßÿ®** (`account_id`)
   - Type: Dropdown with search
   - Required: Yes
   - Database: `uuid NOT NULL FK to accounts`
   - Filter: Active accounts only, `allow_posting = true`
   - Display: code + name_ar (e.g., "1010 - ÿßŸÑŸÜŸÇÿØŸäÿ©")
   - Helper: Show "natural side" hint (debit/credit) but don't restrict user

**Amount Fields (XOR Constraint):**

2. **ŸÖÿØŸäŸÜ** (`debit_amount`)
   - Type: Number input
   - Required: No (but either debit OR credit must be > 0)
   - Database: `numeric(15,4) NOT NULL DEFAULT 0`
   - Validation: >= 0, max 4 decimals
   - XOR Logic: If > 0, credit must = 0

3. **ÿØÿßÿ¶ŸÜ** (`credit_amount`)
   - Type: Number input
   - Required: No (but either debit OR credit must be > 0)
   - Database: `numeric(15,4) NOT NULL DEFAULT 0`
   - Validation: >= 0, max 4 decimals
   - XOR Logic: If > 0, debit must = 0

**Description Field:**

4. **ÿßŸÑÿ®ŸäÿßŸÜ** (`description`)
   - Type: Text input / Textarea
   - Required: No
   - Database: `text NULL`
   - Purpose: Line-specific description (different from header description)
   - Layout: Full width in multi-column view

**Data Isolation & Cost Tracking (All from transaction_lines schema):**

5. **ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©** (`org_id`)
   - Type: Dropdown
   - Required: No (auto-synced by trigger `fn_tl_sync_org`)
   - Database: `uuid NULL`
   - Default: Inherited from header (auto-synced by trigger)
   - Override: Yes (for inter-company transactions)
   - Icon: üîó when inherited
   - **CRITICAL for data isolation**
   - **Note:** While trigger syncs, show for transparency and allow override

6. **ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ** (`project_id`)
   - Type: Dropdown
   - Required: No
   - Database: `uuid NULL FK to projects`
   - Default: Inherited from header
   - Override: Yes (maximum flexibility)
   - Icon: üîó when inherited

7. **ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ™ŸÉŸÑŸÅÿ©** (`cost_center_id`)
   - Type: Dropdown
   - Required: No
   - Database: `uuid NULL FK to cost_centers`
   - Default: None (line-specific)
   - Override: Yes

8. **ÿπŸÜÿµÿ± ÿßŸÑÿπŸÖŸÑ** (`work_item_id`)
   - Type: Dropdown
   - Required: No
   - Database: `uuid NULL FK to work_items`
   - Default: None (line-specific)
   - Filter: By project if applicable

9. **ÿ®ŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ** (`analysis_work_item_id`)
   - Type: Dropdown
   - Required: No
   - Database: `uuid NULL FK to analysis_work_items`
   - Default: None (line-specific)
   - Filter: By org/project

10. **ÿßŸÑÿ™ÿµŸÜŸäŸÅ** (`classification_id`)
    - Type: Dropdown
    - Required: No
    - Database: `uuid NULL FK to transaction_classification`
    - Default: None (line-specific)

11. **ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿßŸÑŸÅÿ±ÿπŸäÿ©** (`sub_tree_id`)
    - Type: Dropdown
    - Required: No
    - Database: `uuid NULL FK to sub_tree`
    - Default: None (line-specific)
    - Filter: By org/accounts/project

**Hidden/Auto-Managed Fields:**
- `id` - uuid PK, auto-generated
- `transaction_id` - uuid FK from state, hidden field
- `line_no` - integer, auto-calculated (max + 1), supports reorder
- `created_at` - timestamptz, auto-generated

**Source Tracking Fields (Usually NULL for manual entry):**
- `source_module` - text NULL
- `source_document_id` - uuid NULL
- `source_document_line_id` - uuid NULL

### ‚úÖ FINAL LINE FIELD COUNT: 11 Visible Fields

**Editable by user:**
1. account_id (required)
2. debit_amount (XOR with credit)
3. credit_amount (XOR with debit)
4. description (optional)
5. org_id (optional, inherited from header)
6. project_id (optional, inherited from header)
7. cost_center_id (optional)
8. work_item_id (optional)
9. analysis_work_item_id (optional)
10. classification_id (optional)
11. sub_tree_id (optional)

**Auto-managed (hidden):**
- id
- transaction_id
- line_no
- created_at

---

## D) UX/Controls for Line Editor

### ‚úÖ CONFIRMED Multi-Column Layout

**Layout Options:**
- 1 column (mobile/compact)
- 2 columns (tablet)
- 3 columns (desktop default)

**Field Display Options:**
- Show/Hide each field
- Reorder fields
- Full width for specific fields (default: ÿßŸÑÿ®ŸäÿßŸÜ)
- Save layout per user

**Layout Settings:**
- Modal: Full-featured column management for **BOTH header AND lines**
- Quick restore: Button next to "ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ÿÆÿ∑Ÿäÿ∑"
- Save to: localStorage + server API (when available)

### ‚úÖ CONFIRMED Line Operations

**Add/Edit/Delete:**
- Add new line
- Edit existing line (inline or form-based)
- Delete line (with confirmation)
- Copy line (duplicate with same values)
- Insert above/below selected line
- Renumber `line_no` (maintain sequence)

**Inheritance from Header:**
- Only `org_id` and `project_id` inherit from header
- All other fields are line-specific (no inheritance)
- Icon üîó shows when value is inherited
- User can override inherited values

### ‚úÖ CONFIRMED Validation (Immediate)

**Client-Side:**
- XOR: Either debit > 0 OR credit > 0 (never both, never neither)
- Amounts: >= 0
- Account: Active, postable, allow_posting = true
- Natural side hint: Show recommended side for account (guidance, not restriction)

**Server-Side (DB Guards):**
- `chk_tl_one_side_positive`: Either debit > 0 XOR credit > 0
- `chk_tl_amounts_non_negative`: Both amounts >= 0
- `fn_check_line_account_postable`: Account must be postable
- `trg_tx_balanced_lines`: Triggers balance check on parent
- `uk_tl_tx_line`: UNIQUE(transaction_id, line_no)

**Error Messages (Arabic):**
- Both amounts > 0: "ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿØÿÆÿßŸÑ ŸÇŸäŸÖÿ© ŸÅŸä ÿßŸÑŸÖÿØŸäŸÜ ŸàÿßŸÑÿØÿßÿ¶ŸÜ ŸÖÿπÿßŸã"
- Both amounts = 0: "Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ŸÇŸäŸÖÿ© ŸÅŸä ÿßŸÑŸÖÿØŸäŸÜ ÿ£Ÿà ÿßŸÑÿØÿßÿ¶ŸÜ"
- Negative amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÖŸàÿ¨ÿ®ÿßŸã"
- Account not postable: "ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ≠ÿØÿØ ÿ∫Ÿäÿ± ŸÇÿßÿ®ŸÑ ŸÑŸÑÿ™ÿ±ÿ≠ŸäŸÑ"

### ‚úÖ CONFIRMED Keyboard Shortcuts

- Alt+N: Add new line
- Delete: Delete selected line
- Enter: Navigate to next field
- Ctrl+S: Save draft
- Esc: Cancel edit mode

### ‚úÖ CONFIRMED Performance Optimizations

**Caching:**
- Cache all dropdowns (accounts, projects, cost_centers, work_items, analysis_items, classification, sub_tree)
- Invalidate cache on data changes
- Lazy load dropdown options on first open

**Debouncing:**
- Search in dropdowns: 300ms debounce
- Auto-save (if enabled): 2000ms debounce

**Rendering:**
- Virtual scrolling for large line lists (>50 lines)
- Memoize expensive calculations
- Batch state updates

---

## E) Totals & Balance Summary

### ‚úÖ CONFIRMED Summary Bar

**Real-time Display:**
- ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿØŸäŸÜ (Total Debits)
- ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØÿßÿ¶ŸÜ (Total Credits)
- ÿßŸÑŸÅÿ±ŸÇ (Balance/Difference)
- ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ∑ÿ± (Line Count)
- Balance Badge: ‚úì Green if balanced, ‚ùå Red if not

**Save Button Logic:**
- "ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≥ŸàÿØÿ©" enabled only when:
  - Transaction is balanced (debits = credits)
  - At least 1 line exists
  - All validations pass
- DB enforces final checks (deferred triggers)

---

## F) Section 3 ‚Äî Attachments

### ‚úÖ REVISED Document Management

**‚ùå NO Transaction-Level Documents**
- Transaction-level documents removed
- All documents are line-level only

**‚úÖ Line-Level Documents ONLY:**
- Inside line table or from line context menu
- Operations: Select, Link existing, Upload & Link, Generate from Template, Refresh
- Counter per line showing attachment count
- Collapsible section per line
- State preserved per user

**Document Operations per Line:**
- Select from existing documents
- Link existing document to line
- Upload new document and link to line
- Generate document from template
- Refresh document list
- Show attachment counter badge

---

## G) Save & Review Workflow

### ‚úÖ CONFIRMED - Use Current Approval Process WITHOUT Modification

**Current workflow works well, keep as-is:**

**1. Draft Creation:**
- Save header ‚Üí Edit lines ‚Üí Save draft
- Requirements: Balanced AND ‚â•1 line (DB enforces)
- Auto-save: Optional feature for header (prevent data loss)

**2. Submit for Review:**
- Uses current app's submission process
- No modifications needed
- Works with existing approval_status field

**3. Review Actions:**
- Uses current app's review process
- No modifications needed
- Approve/Reject/Return functionality unchanged

**4. Posting:**
- Uses current app's posting process
- No modifications needed
- Sets is_posted = true

**5. Audit Logging:**
- Uses current app's audit system
- No modifications needed

**Note:** Do NOT implement new approval workflow. Use existing system.

---

## H) Settings & Preferences

### ‚úÖ REVISED User Preferences

**Layout Management:**
- Full modal for column management (order, width, show/hide)
- **Required for BOTH:**
  - Transaction header form layout
  - Transaction lines form layout
- Save to: localStorage + server API
- Quick restore default button
- Per-user preferences

**Header Default Values:**
- Save current header as user default
- **Fields: ONLY `org_id` and `project_id`** (only these 2 fields have localStorage defaults)
- Load on new transaction creation
- Option to "Save as Default" in header

**Storage Strategy:**
- Primary: localStorage (immediate, always available)
- Secondary: Server API (sync across devices, best-effort)
- Conflict resolution: Server wins, with user notification

---

## I) Protection & DB Integration

### ‚úÖ CONFIRMED Database Guards

**Trust DB Constraints:**
- Account postability: `allow_posting = true`, `is_active = true`
- Balance: `total_debits = total_credits`
- Minimum lines: ‚â•1 line (trigger: `trg_tx_must_have_lines`)
- Amounts: XOR constraint (`chk_tl_one_side_positive`)

**Error Surfacing:**
- Catch DB errors
- Parse trigger messages
- Display in Arabic with clear guidance
- Log errors for debugging

**No Legacy Fields:**
- No single-line legacy fields in UI or API
- Complete migration to header-lines model

---

## J) Permissions & Conditional Visibility

### ‚úÖ CONFIRMED Permission Model

**Permissions:**
- `create`: Create new transactions
- `update`: Update draft/revision_requested transactions
- `delete`: Delete draft transactions
- `post`: Post approved transactions
- `review`: Approve/reject/return submitted transactions
- `manage`: Full access (admin)

**Conditional Display:**

**By Status:**
- Draft: Show edit/delete, hide approve/reject
- Submitted: Show approve/reject/return, hide edit
- Approved: Show post, hide edit/approve
- Posted: All edit operations disabled, show as read-only

**By Permission:**
- Create: Show "New Transaction" button
- Update: Enable edit mode based on status
- Delete: Show delete button for drafts
- Review: Show approve/reject/return buttons
- Post: Show post button for approved transactions
- Manage: Override all restrictions (with caution)

**Field Locking:**
- After posting: All header and line fields become read-only
- After approval: Limited fields editable (only with revision request)

---

## K) Performance & Reliability

### ‚úÖ CONFIRMED Optimization Strategies

**Caching:**
- All dropdown lists cached on first load
- Invalidate on data changes (WebSocket or polling)
- Lazy loading for large lists

**Loading States:**
- Skeleton loaders for initial load
- Inline spinners for actions (save, delete, etc.)
- No flickering on modal open/close

**Auto-Save (Optional):**
- Header only (prevent data loss)
- Configurable interval (default: 2 seconds)
- Visual indicator when saving
- Conflict resolution: Server wins

**Error Handling:**
- Graceful degradation on network errors
- Retry logic for failed saves
- Local storage backup for drafts
- Clear error messages in Arabic

---

## L) Quick Clarification Responses - REVISED

### 1. Header Fields - Final Count?

**‚úÖ ANSWER:** 8 editable fields (matching transactions table schema EXACTLY)

**From `transactions` table:**
1. entry_date (required)
2. description (required)
3. description_ar (optional)
4. org_id (required, default from localStorage)
5. project_id (optional, default from localStorage)
6. reference_number (optional)
7. notes (optional)
8. notes_ar (optional)

**NOT in header (these don't exist in transactions table):**
- ‚ùå cost_center_id
- ‚ùå classification_id
- ‚ùå analysis_work_item_id
- ‚ùå sub_tree_id
- ‚ùå work_item_id

### 2. Line Fields - Final Count?

**‚úÖ ANSWER:** 11 editable fields (matching transaction_lines table schema EXACTLY)

**From `transaction_lines` table:**
1. account_id (required)
2. debit_amount (XOR with credit)
3. credit_amount (XOR with debit)
4. description (optional)
5. org_id (optional, inherited from header)
6. project_id (optional, inherited from header)
7. cost_center_id (optional, line-specific)
8. work_item_id (optional, line-specific)
9. analysis_work_item_id (optional, line-specific)
10. classification_id (optional, line-specific)
11. sub_tree_id (optional, line-specific)

### 3. Inheritance Pattern?

**‚úÖ ANSWER:** Only `org_id` and `project_id` inherit from header to lines

**Inheritance:**
- org_id: Inherited from header (auto-synced by trigger, show for transparency)
- project_id: Inherited from header (user can override)

**NOT inherited (line-specific):**
- cost_center_id
- work_item_id
- analysis_work_item_id
- classification_id
- sub_tree_id

### 4. Documents?

**‚úÖ ANSWER:** Line-level documents ONLY, no transaction-level documents

**Implementation:**
- Each line can have attachments
- Show attachment counter per line
- Operations: Select, Link, Upload, Generate, Refresh
- Collapsible per line

### 5. Approval Workflow?

**‚úÖ ANSWER:** Use CURRENT app workflow, do NOT modify

**Keep existing:**
- Current submission process
- Current review process
- Current approval/reject/return
- Current posting process
- Current audit logging

### 6. Layout Settings?

**‚úÖ ANSWER:** Column management for BOTH header AND lines

**Implementation:**
- Modal with tabs: "Header Layout" and "Lines Layout"
- Each can customize column order, visibility, width
- Save preferences per user
- Quick restore default

### 7. Default Values in localStorage?

**‚úÖ ANSWER:** ONLY `org_id` and `project_id`

**These two fields:**
- Loaded from localStorage on new transaction
- User can see and change
- Cascade to lines as defaults
- Option to save current values as new defaults

---

## M) Implementation Priority

### Phase 1: Core CRUD (Week 1)
1. Header form with 8 fields (matching schema)
2. Line editor with 11 fields (matching schema)
3. Add/Edit/Delete line operations
4. Save draft (with balance check)
5. Totals summary bar

### Phase 2: Inheritance & Defaults (Week 2)
6. localStorage for org_id and project_id defaults
7. Inheritance from header to lines (org_id, project_id only)
8. Override capability in lines
9. Visual indicators (üîó) for inherited values

### Phase 3: Documents (Week 3)
10. Line-level document management
11. Attachment counter per line
12. Upload, Link, Select operations

### Phase 4: Layout & Preferences (Week 4)
13. Layout settings modal (header + lines tabs)
14. Column management (order, visibility, width)
15. Save/restore user preferences
16. localStorage + server sync

### Phase 5: UX Polish (Week 5)
17. Keyboard shortcuts
18. Auto-save (optional)
19. Performance optimizations (caching, lazy loading)
20. Error handling improvements
21. Accessibility (ARIA, keyboard navigation)

---

## N) Critical Success Metrics

‚úÖ **Schema Compliance:**
- 100% match with database schema (no extra fields)
- All fields have correct data types
- All constraints enforced

‚úÖ **Data Integrity:**
- 100% balance enforcement (debits = credits)
- 100% XOR enforcement (debit XOR credit per line)
- Zero data loss (auto-save, audit trail)

‚úÖ **Performance:**
- Page load < 2 seconds
- Save operation < 1 second
- Dropdown search < 300ms
- Support 100+ lines without lag

‚úÖ **Usability:**
- 3 clicks to create transaction (header ‚Üí lines ‚Üí save)
- Keyboard shortcuts reduce mouse usage by 50%
- Templates reduce repetitive entry by 80%

---

## O) Final Confirmation Checklist

- ‚úÖ Header: 8 fields (EXACTLY matching transactions table)
- ‚úÖ Lines: 11 fields (EXACTLY matching transaction_lines table)
- ‚úÖ No extra fields added (schema-compliant)
- ‚úÖ Inheritance: ONLY org_id and project_id
- ‚úÖ Documents: Line-level ONLY
- ‚úÖ Approval: Use CURRENT workflow (no changes)
- ‚úÖ Layout: For BOTH header and lines
- ‚úÖ Defaults: ONLY org_id and project_id in localStorage
- ‚úÖ Validation: Client + DB guards
- ‚úÖ Performance: Caching, lazy loading, debouncing
- ‚úÖ RTL: Full Arabic support

---

**END OF REVISED CLARIFICATION RESPONSE**

**Ready to Proceed:** All clarifications addressed with exact schema compliance. Please confirm and begin implementation.