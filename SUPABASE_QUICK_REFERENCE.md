# Supabase SQL - Quick Reference Card\n\n## Database Schema\n\n### New Tables\n\n```\nedit_requests\n├── id (UUID, PK)\n├── transaction_id (UUID, FK)\n├── requested_by (UUID, FK)\n├── requested_at (TIMESTAMPTZ)\n├── reason (TEXT)\n├── status (TEXT: pending|approved|rejected)\n├── reviewed_by (UUID, FK)\n├── reviewed_at (TIMESTAMPTZ)\n└── review_note (TEXT)\n\nresubmissions\n├── id (UUID, PK)\n├── transaction_id (UUID, FK)\n├── resubmitted_by (UUID, FK)\n├── resubmitted_at (TIMESTAMPTZ)\n├── previous_status (TEXT)\n└── reason (TEXT)\n\ntransaction_audit_log\n├── id (UUID, PK)\n├── transaction_id (UUID, FK)\n├── action (TEXT: create|edit|submit|approve|reject|resubmit|post|delete)\n├── actor_id (UUID, FK)\n├── actor_name (TEXT)\n├── changes (JSONB)\n├── previous_values (JSONB)\n├── new_values (JSONB)\n└── created_at (TIMESTAMPTZ)\n```\n\n### New Columns in transactions\n\n```\napproval_status (TEXT: draft|submitted|approved|rejected|revision_requested)\nis_posted (BOOLEAN)\nedit_locked (BOOLEAN)\nlocked_reason (TEXT)\nlocked_by (UUID, FK)\nlocked_at (TIMESTAMPTZ)\nsubmitted_at (TIMESTAMPTZ)\nsubmitted_by (UUID, FK)\napproved_at (TIMESTAMPTZ)\napproved_by (UUID, FK)\nrejection_reason (TEXT)\nrejected_at (TIMESTAMPTZ)\nrejected_by (UUID, FK)\n```\n\n---\n\n## Functions\n\n### 1. Submit for Approval\n\n```sql\nSELECT submit_transaction_for_approval(\n  p_transaction_id UUID,\n  p_user_id UUID\n) RETURNS JSONB;\n```\n\n**Usage**:\n```typescript\nawait supabase.rpc('submit_transaction_for_approval', {\n  p_transaction_id: transactionId,\n  p_user_id: userId\n})\n```\n\n---\n\n### 2. Approve Transaction\n\n```sql\nSELECT approve_transaction(\n  p_transaction_id UUID,\n  p_user_id UUID,\n  p_note TEXT (optional)\n) RETURNS JSONB;\n```\n\n**Usage**:\n```typescript\nawait supabase.rpc('approve_transaction', {\n  p_transaction_id: transactionId,\n  p_user_id: userId,\n  p_note: 'Approved'\n})\n```\n\n---\n\n### 3. Reject Transaction\n\n```sql\nSELECT reject_transaction(\n  p_transaction_id UUID,\n  p_user_id UUID,\n  p_reason TEXT\n) RETURNS JSONB;\n```\n\n**Usage**:\n```typescript\nawait supabase.rpc('reject_transaction', {\n  p_transaction_id: transactionId,\n  p_user_id: userId,\n  p_reason: 'Amount is incorrect'\n})\n```\n\n---\n\n### 4. Request Edit\n\n```sql\nSELECT request_edit_for_transaction(\n  p_transaction_id UUID,\n  p_user_id UUID,\n  p_reason TEXT\n) RETURNS JSONB;\n```\n\n**Usage**:\n```typescript\nawait supabase.rpc('request_edit_for_transaction', {\n  p_transaction_id: transactionId,\n  p_user_id: userId,\n  p_reason: 'Need to fix the description'\n})\n```\n\n---\n\n### 5. Approve Edit Request\n\n```sql\nSELECT approve_edit_request(\n  p_request_id UUID,\n  p_user_id UUID,\n  p_note TEXT (optional)\n) RETURNS JSONB;\n```\n\n**Usage**:\n```typescript\nawait supabase.rpc('approve_edit_request', {\n  p_request_id: requestId,\n  p_user_id: userId,\n  p_note: 'Approved for editing'\n})\n```\n\n---\n\n### 6. Resubmit Transaction\n\n```sql\nSELECT resubmit_transaction(\n  p_transaction_id UUID,\n  p_user_id UUID,\n  p_reason TEXT (optional)\n) RETURNS JSONB;\n```\n\n**Usage**:\n```typescript\nawait supabase.rpc('resubmit_transaction', {\n  p_transaction_id: transactionId,\n  p_user_id: userId,\n  p_reason: 'Fixed as requested'\n})\n```\n\n---\n\n## Common Queries\n\n### Get Draft Transactions\n\n```sql\nSELECT * FROM transactions \nWHERE approval_status = 'draft'\nORDER BY created_at DESC;\n```\n\n### Get Pending Approvals\n\n```sql\nSELECT * FROM transactions \nWHERE approval_status = 'submitted'\nORDER BY submitted_at DESC;\n```\n\n### Get Pending Edit Requests\n\n```sql\nSELECT \n  er.*,\n  t.entry_number,\n  t.description\nFROM edit_requests er\nJOIN transactions t ON er.transaction_id = t.id\nWHERE er.status = 'pending'\nORDER BY er.requested_at DESC;\n```\n\n### Get Transaction Audit Trail\n\n```sql\nSELECT \n  action,\n  actor_id,\n  actor_name,\n  changes,\n  created_at\nFROM transaction_audit_log\nWHERE transaction_id = 'TRANSACTION_ID'\nORDER BY created_at DESC;\n```\n\n### Get Resubmission History\n\n```sql\nSELECT \n  previous_status,\n  reason,\n  resubmitted_at\nFROM resubmissions\nWHERE transaction_id = 'TRANSACTION_ID'\nORDER BY resubmitted_at DESC;\n```\n\n### Get Transaction Full Status\n\n```sql\nSELECT \n  t.id,\n  t.entry_number,\n  t.approval_status,\n  t.is_posted,\n  t.submitted_at,\n  t.approved_at,\n  t.rejected_at,\n  COUNT(DISTINCT er.id) as pending_edits,\n  COUNT(DISTINCT r.id) as resubmissions\nFROM transactions t\nLEFT JOIN edit_requests er ON t.id = er.transaction_id AND er.status = 'pending'\nLEFT JOIN resubmissions r ON t.id = r.transaction_id\nWHERE t.id = 'TRANSACTION_ID'\nGROUP BY t.id;\n```\n\n---\n\n## Status Flow\n\n```\n┌─────────┐\n│ DRAFT   │ ← User creates transaction\n└────┬────┘\n     │ Save as Draft\n     ├─────────────────────────────────┐\n     │                                 │\n     ▼                                 │\n┌──────────────┐                       │\n│ SUBMITTED    │ ← User sends for approval\n└────┬─────────┘                       │\n     │                                 │\n     ├─ Approve ──────────────────┐    │\n     │                            │    │\n     ├─ Reject ──────────────────┐│    │\n     │                           ││    │\n     ├─ Request Edit ────────────┐││   │\n     │                           │││   │\n     ▼                           │││   │\n┌──────────────┐                 │││   │\n│ APPROVED     │                 │││   │\n└──────────────┘                 │││   │\n                                 │││   │\n                                 ▼││   │\n                            ┌──────────┐\n                            │ REJECTED │\n                            └──────────┘\n                                 │\n                                 │ Resubmit\n                                 ▼\n                            ┌──────────────┐\n                            │ SUBMITTED    │\n                            └──────────────┘\n                                 │\n                                 ▼\n                            ┌──────────────────┐\n                            │ REVISION_REQUESTED│\n                            └──────────────────┘\n                                 │\n                                 │ Edit & Resubmit\n                                 ▼\n                            ┌──────────────┐\n                            │ SUBMITTED    │\n                            └──────────────┘\n```\n\n---\n\n## Indexes for Performance\n\n```\nidx_transactions_approval_status\nidx_transactions_is_posted\nidx_transactions_submitted_by\nidx_transactions_approved_by\nidx_transactions_created_by\nidx_edit_requests_transaction\nidx_edit_requests_status\nidx_edit_requests_requested_by\nidx_edit_requests_reviewed_by\nidx_resubmissions_transaction\nidx_resubmissions_resubmitted_by\nidx_audit_log_transaction\nidx_audit_log_action\nidx_audit_log_actor\nidx_audit_log_created_at\n```\n\n---\n\n## RLS Policies\n\n### edit_requests\n- SELECT: Users can view their own requests or requests for their transactions\n- INSERT: Users can create requests\n- UPDATE: Reviewers can update requests\n\n### resubmissions\n- SELECT: Users can view their own resubmissions or resubmissions for their transactions\n- INSERT: Users can create resubmissions\n\n### transaction_audit_log\n- SELECT: Users can view audit logs for their transactions\n\n---\n\n## Verification Checklist\n\n- [ ] 3 new tables created\n- [ ] 13 new columns added to transactions\n- [ ] 6 functions created\n- [ ] 15+ indexes created\n- [ ] RLS policies enabled\n- [ ] All verification queries pass\n- [ ] Test data inserted successfully\n- [ ] Functions execute without errors\n\n---\n\n## Rollback Command\n\nIf you need to undo all changes:\n\n```sql\n-- Run the cleanup section at the end of SUPABASE_TRANSACTION_EDIT_SYSTEM_SQL.sql\n```\n\n---\n\n**Status**: ✅ Ready for Production\n"} 
