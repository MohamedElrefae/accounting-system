# Supabase Implementation Guide - Transaction Edit System\n\n## Overview\n\nThis guide walks through implementing the complete transaction edit system in Supabase with draft/submit, edit requests, and resubmissions.\n\n---\n\n## Step 1: Execute SQL Script\n\n### 1.1: Access Supabase SQL Editor\n\n1. Go to your Supabase project\n2. Click **SQL Editor** in the left sidebar\n3. Click **New Query**\n4. Copy the entire content from `SUPABASE_TRANSACTION_EDIT_SYSTEM_SQL.sql`\n5. Paste into the SQL editor\n6. Click **Run**\n\n### 1.2: Expected Output\n\nYou should see:\n```\nQuery executed successfully\nNo rows returned\n```\n\n---\n\n## Step 2: Verify Installation\n\n### 2.1: Run Verification Queries\n\nExecute each verification query separately:\n\n#### Query 1: Verify Tables\n```sql\nSELECT \n  table_name,\n  CASE \n    WHEN table_name IN ('edit_requests', 'resubmissions', 'transaction_audit_log') THEN 'NEW'\n    ELSE 'EXISTING'\n  END as table_type\nFROM information_schema.tables \nWHERE table_schema = 'public' \nAND table_name IN ('transactions', 'edit_requests', 'resubmissions', 'transaction_audit_log')\nORDER BY table_name;\n```\n\n**Expected Result**:\n```\ntable_name                  | table_type\n----------------------------+----------\nedit_requests              | NEW\nresubmissions              | NEW\ntransaction_audit_log      | NEW\ntransactions               | EXISTING\n```\n\n#### Query 2: Verify Columns\n```sql\nSELECT \n  column_name,\n  data_type,\n  is_nullable\nFROM information_schema.columns \nWHERE table_name = 'transactions' \nAND column_name IN (\n  'approval_status', 'is_posted', 'edit_locked', 'locked_reason', 'locked_by', 'locked_at',\n  'submitted_at', 'submitted_by', 'approved_at', 'approved_by', 'rejection_reason', 'rejected_at', 'rejected_by'\n)\nORDER BY column_name;\n```\n\n**Expected Result**: 13 rows with new columns\n\n#### Query 3: Verify Indexes\n```sql\nSELECT \n  indexname,\n  tablename\nFROM pg_indexes \nWHERE schemaname = 'public' \nAND (tablename IN ('transactions', 'edit_requests', 'resubmissions', 'transaction_audit_log')\n  OR indexname LIKE 'idx_%')\nORDER BY tablename, indexname;\n```\n\n**Expected Result**: Multiple indexes for performance\n\n#### Query 4: Verify Functions\n```sql\nSELECT \n  routine_name,\n  routine_type\nFROM information_schema.routines \nWHERE routine_schema = 'public' \nAND routine_name IN (\n  'submit_transaction_for_approval',\n  'approve_transaction',\n  'reject_transaction',\n  'request_edit_for_transaction',\n  'approve_edit_request',\n  'resubmit_transaction'\n)\nORDER BY routine_name;\n```\n\n**Expected Result**: 6 functions\n\n#### Query 5: Verify RLS Policies\n```sql\nSELECT \n  schemaname,\n  tablename,\n  policyname,\n  permissive,\n  roles\nFROM pg_policies \nWHERE schemaname = 'public' \nAND tablename IN ('edit_requests', 'resubmissions', 'transaction_audit_log')\nORDER BY tablename, policyname;\n```\n\n**Expected Result**: Multiple RLS policies\n\n---\n\n## Step 3: Test Functionality\n\n### 3.1: Test Draft Transaction\n\n```sql\n-- Create a test transaction (draft)\nINSERT INTO transactions (\n  entry_number,\n  entry_date,\n  description,\n  org_id,\n  approval_status,\n  created_by\n) VALUES (\n  'TEST-001',\n  NOW(),\n  'Test Draft Transaction',\n  'YOUR_ORG_ID',\n  'draft',\n  'YOUR_USER_ID'\n) RETURNING id, approval_status;\n```\n\n### 3.2: Test Submit for Approval\n\n```sql\n-- Submit transaction for approval\nSELECT submit_transaction_for_approval(\n  'TRANSACTION_ID_FROM_ABOVE',\n  'YOUR_USER_ID'\n);\n\n-- Verify status changed\nSELECT id, approval_status, submitted_at, submitted_by \nFROM transactions \nWHERE id = 'TRANSACTION_ID_FROM_ABOVE';\n```\n\n### 3.3: Test Approve Transaction\n\n```sql\n-- Approve transaction\nSELECT approve_transaction(\n  'TRANSACTION_ID_FROM_ABOVE',\n  'APPROVER_USER_ID',\n  'Looks good'\n);\n\n-- Verify status changed\nSELECT id, approval_status, approved_at, approved_by \nFROM transactions \nWHERE id = 'TRANSACTION_ID_FROM_ABOVE';\n```\n\n### 3.4: Test Edit Request\n\n```sql\n-- Create another transaction for edit request test\nINSERT INTO transactions (\n  entry_number,\n  entry_date,\n  description,\n  org_id,\n  approval_status,\n  created_by\n) VALUES (\n  'TEST-002',\n  NOW(),\n  'Test Edit Request',\n  'YOUR_ORG_ID',\n  'submitted',\n  'YOUR_USER_ID'\n) RETURNING id;\n\n-- Request edit\nSELECT request_edit_for_transaction(\n  'TRANSACTION_ID_FROM_ABOVE',\n  'YOUR_USER_ID',\n  'Need to fix the amount'\n);\n\n-- Verify edit request created\nSELECT id, transaction_id, reason, status \nFROM edit_requests \nWHERE transaction_id = 'TRANSACTION_ID_FROM_ABOVE';\n```\n\n### 3.5: Test Approve Edit Request\n\n```sql\n-- Approve edit request\nSELECT approve_edit_request(\n  'EDIT_REQUEST_ID_FROM_ABOVE',\n  'APPROVER_USER_ID',\n  'Approved for editing'\n);\n\n-- Verify transaction status changed to revision_requested\nSELECT id, approval_status, edit_locked \nFROM transactions \nWHERE id = 'TRANSACTION_ID_FROM_ABOVE';\n```\n\n### 3.6: Test Resubmit\n\n```sql\n-- Resubmit transaction\nSELECT resubmit_transaction(\n  'TRANSACTION_ID_FROM_ABOVE',\n  'YOUR_USER_ID',\n  'Fixed the amount as requested'\n);\n\n-- Verify status changed back to submitted\nSELECT id, approval_status, submitted_at \nFROM transactions \nWHERE id = 'TRANSACTION_ID_FROM_ABOVE';\n\n-- Verify resubmission record created\nSELECT id, transaction_id, previous_status, reason \nFROM resubmissions \nWHERE transaction_id = 'TRANSACTION_ID_FROM_ABOVE';\n```\n\n---\n\n## Step 4: View Audit Trail\n\n```sql\n-- View all changes to a transaction\nSELECT \n  id,\n  action,\n  actor_id,\n  actor_name,\n  changes,\n  created_at\nFROM transaction_audit_log\nWHERE transaction_id = 'TRANSACTION_ID_FROM_ABOVE'\nORDER BY created_at DESC;\n```\n\n---\n\n## Step 5: Backend Integration\n\n### 5.1: Update Transaction Service\n\nModify `src/services/transactions.ts`:\n\n```typescript\n// Add submitForApproval flag handling\nexport const createTransaction = async (data: any) => {\n  const { submitForApproval, ...transactionData } = data\n  \n  // Set approval_status based on flag\n  const approval_status = submitForApproval ? 'submitted' : 'draft'\n  \n  const { data: result, error } = await supabase\n    .from('transactions')\n    .insert({\n      ...transactionData,\n      approval_status,\n      submitted_at: submitForApproval ? new Date().toISOString() : null,\n      submitted_by: submitForApproval ? getCurrentUserId() : null\n    })\n    .select()\n    .single()\n  \n  if (error) throw error\n  return result\n}\n\n// Add submit for approval function\nexport const submitTransactionForApproval = async (transactionId: string) => {\n  const { data, error } = await supabase\n    .rpc('submit_transaction_for_approval', {\n      p_transaction_id: transactionId,\n      p_user_id: getCurrentUserId()\n    })\n  \n  if (error) throw error\n  return data\n}\n\n// Add approve function\nexport const approveTransaction = async (transactionId: string, note?: string) => {\n  const { data, error } = await supabase\n    .rpc('approve_transaction', {\n      p_transaction_id: transactionId,\n      p_user_id: getCurrentUserId(),\n      p_note: note\n    })\n  \n  if (error) throw error\n  return data\n}\n\n// Add reject function\nexport const rejectTransaction = async (transactionId: string, reason: string) => {\n  const { data, error } = await supabase\n    .rpc('reject_transaction', {\n      p_transaction_id: transactionId,\n      p_user_id: getCurrentUserId(),\n      p_reason: reason\n    })\n  \n  if (error) throw error\n  return data\n}\n```\n\n### 5.2: Update Edit Requests Service\n\nModify `src/services/editRequests.ts`:\n\n```typescript\n// Add approve edit request function\nexport const approveEditRequest = async (requestId: string, note?: string) => {\n  const { data, error } = await supabase\n    .rpc('approve_edit_request', {\n      p_request_id: requestId,\n      p_user_id: getCurrentUserId(),\n      p_note: note\n    })\n  \n  if (error) throw error\n  return data\n}\n```\n\n### 5.3: Update Resubmissions Service\n\nModify `src/services/resubmissions.ts`:\n\n```typescript\n// Add resubmit function\nexport const resubmitTransaction = async (transactionId: string, reason?: string) => {\n  const { data, error } = await supabase\n    .rpc('resubmit_transaction', {\n      p_transaction_id: transactionId,\n      p_user_id: getCurrentUserId(),\n      p_reason: reason\n    })\n  \n  if (error) throw error\n  return data\n}\n```\n\n---\n\n## Step 6: Frontend Integration\n\n### 6.1: Update TransactionWizard\n\nThe `handleSaveDraft` function already passes `submitForApproval: false`\nThe `handleSubmit` function already passes `submitForApproval: true`\n\nNo changes needed - already implemented!\n\n### 6.2: Update Transactions Page\n\nAdd buttons for approval actions:\n\n```typescript\n// In Transactions.tsx\nconst handleApprove = async (transactionId: string) => {\n  try {\n    await approveTransaction(transactionId)\n    showToast('تم الموافقة على المعاملة', { severity: 'success' })\n    reload()\n  } catch (error) {\n    showToast('فشل الموافقة', { severity: 'error' })\n  }\n}\n\nconst handleReject = async (transactionId: string, reason: string) => {\n  try {\n    await rejectTransaction(transactionId, reason)\n    showToast('تم رفض المعاملة', { severity: 'success' })\n    reload()\n  } catch (error) {\n    showToast('فشل الرفض', { severity: 'error' })\n  }\n}\n```\n\n---\n\n## Troubleshooting\n\n### Issue: \"Permission denied\" error\n\n**Solution**: Check RLS policies are enabled and user has correct permissions\n\n```sql\n-- Verify RLS is enabled\nSELECT tablename, rowsecurity \nFROM pg_tables \nWHERE tablename IN ('edit_requests', 'resubmissions', 'transaction_audit_log');\n```\n\n### Issue: Function not found\n\n**Solution**: Verify functions were created\n\n```sql\nSELECT routine_name \nFROM information_schema.routines \nWHERE routine_schema = 'public' \nAND routine_name LIKE '%transaction%';\n```\n\n### Issue: Columns not found\n\n**Solution**: Verify ALTER TABLE commands executed\n\n```sql\nSELECT column_name \nFROM information_schema.columns \nWHERE table_name = 'transactions' \nAND column_name LIKE 'approval%';\n```\n\n---\n\n## Summary\n\n✅ **Tables Created**: 3 new tables  \n✅ **Columns Added**: 13 new columns to transactions  \n✅ **Functions Created**: 6 business logic functions  \n✅ **Indexes Created**: Multiple for performance  \n✅ **RLS Policies**: Enabled for security  \n✅ **Status**: Ready for production\n\n---\n\n## Next Steps\n\n1. Run the SQL script\n2. Verify all components\n3. Test functionality\n4. Integrate with backend\n5. Deploy to production\n"} 
