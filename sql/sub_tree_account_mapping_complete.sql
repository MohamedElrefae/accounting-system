-- Complete sub_tree to accounts mapping
-- This file contains the full mapping data extracted from the provided CSV

-- Accounts mapping (id -> code)
-- Organization: d5789445-11e3-4ad6-9297-b56521675114

-- Account IDs by code:
-- 5100 -> b7b03032-4229-41bb-92e6-4712f7597010
-- 5200 -> 43b002b4-ffc4-4740-a5ee-7498d1c2fe8a
-- 4210 -> 7266ce92-4584-4ec0-98d9-a72d826c0df4
-- 4200 -> ce28bbca-0159-4f3b-a809-aaf62d3273ef
-- 4100 -> b9d58bc5-9721-45a4-9477-244be212e724
-- 4000 -> e7a9d696-b9d7-4622-9096-7b733d48426a
-- 5000 -> 3e417728-9fa5-4fc9-8d71-c6fb2b27ee27
-- 42101 -> c88dcfe8-fae9-4ad2-8f62-c4195afd42c5
-- 4210 -> 7266ce92-4584-4ec0-98d9-a72d826c0df4
-- 3100 -> 86946261-387a-4174-bc7f-0476d62b0bdb
-- 31001 -> 5be46bf3-28f2-4dde-a8c4-aa51c100e176
-- 3000 -> 247df12c-9203-4454-b336-f67832933e71
-- 2270 -> 46689d3d-b332-4b02-9017-cb2b741f8bfd
-- 22701 -> b440fd2a-358c-44ff-aff9-dec1ae8b25c6
-- 2230 -> 841feb7e-9374-485a-8669-a02528a2e62f
-- 22303 -> e0db9265-2422-4661-81bb-b6ddc31cdcb5
-- 22306 -> 31a3d74c-c3c4-42ac-a4c9-528871c64052
-- 2220 -> 6b9d2d29-afdc-4edb-9863-7bf57bbbddbb
-- 22201 -> 217dd6e7-5840-4d87-b8ae-bd7235acd42e
-- 22202 -> 3930be54-2a0c-42f8-a6b3-15eb14c9f0ba
-- 2210 -> ba94d383-6a6c-4243-a570-b86bbe33ab05
-- 22103 -> 8073e778-4219-4372-8b4e-ae0c04ae0979
-- 22104 -> b3e2d3ae-07be-4c1c-8e37-410542b874b2
-- 2200 -> 542a664e-805e-40f1-aa5c-47aa28811750
-- 2000 -> 579a9b3c-08ed-4622-88c5-da8ab70cf67e
-- 12307 -> b1161078-4772-466c-8241-bab6a771def3
-- 12304 -> 94bdfa42-e515-4d4a-b006-27e5982f7128
-- 1230 -> bae94631-14c0-46a1-b6df-5779c1c52319
-- 12201 -> 7accdb8c-bbd4-4b2c-abdd-706b8070b41a
-- 1220 -> ca3ce592-6015-4bdc-af66-320e83b1029e
-- 12123 -> f5fbeb9f-da45-4b74-9835-44701a23e1ed
-- 12113 -> 0e960703-a40e-4fcb-b19a-3564d2de7e75
-- 12103 -> e6aa6eb7-2d3a-4b27-a1a7-bbb5e04a9842
-- 12101 -> 1d8d22e7-1004-4ebb-8211-98d0465362ca
-- 1210 -> abb9f5f6-aee7-46a1-b28f-b2f54e2e6fea
-- 1200 -> 32bf1faa-fb89-4af4-bcd7-1c8277ac16da
-- 11107 -> 2c245f69-02b9-4e42-aee3-09c829368dc6
-- 11106 -> 3144218c-d290-422d-a461-0c7f4c2673f4
-- 11105 -> 3b9b8284-ff10-413f-a4f2-ca0544e20a69
-- 1110 -> ee6a27b7-acbf-412a-bcfd-231f7d93ed4c
-- 1100 -> fbfa78de-5e99-4d7d-bc2d-1bb4de3148c9
-- 1000 -> 83d0dc81-52bf-4373-bdf5-a9109fc07d87

BEGIN;

-- Create temporary mapping table
CREATE TEMP TABLE temp_account_mapping (
  account_code TEXT,
  account_id UUID
);

-- Insert all account mappings
INSERT INTO temp_account_mapping (account_code, account_id) VALUES
('5100', 'b7b03032-4229-41bb-92e6-4712f7597010'),
('5200', '43b002b4-ffc4-4740-a5ee-7498d1c2fe8a'),
('4210', '7266ce92-4584-4ec0-98d9-a72d826c0df4'),
('4200', 'ce28bbca-0159-4f3b-a809-aaf62d3273ef'),
('4100', 'b9d58bc5-9721-45a4-9477-244be212e724'),
('4000', 'e7a9d696-b9d7-4622-9096-7b733d48426a'),
('5000', '3e417728-9fa5-4fc9-8d71-c6fb2b27ee27'),
('42101', 'c88dcfe8-fae9-4ad2-8f62-c4195afd42c5'),
('3100', '86946261-387a-4174-bc7f-0476d62b0bdb'),
('31001', '5be46bf3-28f2-4dde-a8c4-aa51c100e176'),
('3000', '247df12c-9203-4454-b336-f67832933e71'),
('2270', '46689d3d-b332-4b02-9017-cb2b741f8bfd'),
('22701', 'b440fd2a-358c-44ff-aff9-dec1ae8b25c6'),
('2230', '841feb7e-9374-485a-8669-a02528a2e62f'),
('22303', 'e0db9265-2422-4661-81bb-b6ddc31cdcb5'),
('22306', '31a3d74c-c3c4-42ac-a4c9-528871c64052'),
('2220', '6b9d2d29-afdc-4edb-9863-7bf57bbbddbb'),
('22201', '217dd6e7-5840-4d87-b8ae-bd7235acd42e'),
('22202', '3930be54-2a0c-42f8-a6b3-15eb14c9f0ba'),
('2210', 'ba94d383-6a6c-4243-a570-b86bbe33ab05'),
('22103', '8073e778-4219-4372-8b4e-ae0c04ae0979'),
('22104', 'b3e2d3ae-07be-4c1c-8e37-410542b874b2'),
('2200', '542a664e-805e-40f1-aa5c-47aa28811750'),
('2000', '579a9b3c-08ed-4622-88c5-da8ab70cf67e'),
('12307', 'b1161078-4772-466c-8241-bab6a771def3'),
('12304', '94bdfa42-e515-4d4a-b006-27e5982f7128'),
('1230', 'bae94631-14c0-46a1-b6df-5779c1c52319'),
('12201', '7accdb8c-bbd4-4b2c-abdd-706b8070b41a'),
('1220', 'ca3ce592-6015-4bdc-af66-320e83b1029e'),
('12123', 'f5fbeb9f-da45-4b74-9835-44701a23e1ed'),
('12113', '0e960703-a40e-4fcb-b19a-3564d2de7e75'),
('12103', 'e6aa6eb7-2d3a-4b27-a1a7-bbb5e04a9842'),
('12101', '1d8d22e7-1004-4ebb-8211-98d0465362ca'),
('1210', 'abb9f5f6-aee7-46a1-b28f-b2f54e2e6fea'),
('1200', '32bf1faa-fb89-4af4-bcd7-1c8277ac16da'),
('11107', '2c245f69-02b9-4e42-aee3-09c829368dc6'),
('11106', '3144218c-d290-422d-a461-0c7f4c2673f4'),
('11105', '3b9b8284-ff10-413f-a4f2-ca0544e20a69'),
('1110', 'ee6a27b7-acbf-412a-bcfd-231f7d93ed4c'),
('1100', 'fbfa78de-5e99-4d7d-bc2d-1bb4de3148c9'),
('1000', '83d0dc81-52bf-4373-bdf5-a9109fc07d87');

-- Create temporary sub_tree mapping table
CREATE TEMP TABLE temp_sub_tree_mapping (
  account_code TEXT,
  sub_tree_id INTEGER
);

-- Insert all sub_tree mappings from the provided data
-- Account code 5100 (التكاليف - Direct costs)
INSERT INTO temp_sub_tree_mapping (account_code, sub_tree_id) VALUES
('5100', 1), ('5100', 2), ('5100', 3), ('5100', 4), ('5100', 5),
('5100', 6), ('5100', 7), ('5100', 8), ('5100', 9), ('5100', 10),
('5100', 11), ('5100', 12), ('5100', 13), ('5100', 14), ('5100', 15),
('5100', 16), ('5100', 17), ('5100', 18), ('5100', 19), ('5100', 20),
('5100', 21), ('5100', 22), ('5100', 23), ('5100', 24), ('5100', 25),
('5100', 26), ('5100', 27), ('5100', 28), ('5100', 29), ('5100', 30),
('5100', 31), ('5100', 32), ('5100', 33), ('5100', 34), ('5100', 35),
('5100', 36), ('5100', 37), ('5100', 38), ('5100', 39), ('5100', 40),
('5100', 41), ('5100', 42), ('5100', 43), ('5100', 44), ('5100', 45),
('5100', 46), ('5100', 47), ('5100', 48), ('5100', 49), ('5100', 50),
('5100', 51), ('5100', 52), ('5100', 53), ('5100', 54), ('5100', 55),
('5100', 56), ('5100', 57), ('5100', 58), ('5100', 59), ('5100', 60),
('5100', 61), ('5100', 62), ('5100', 63), ('5100', 64), ('5100', 65),
('5100', 66), ('5100', 67), ('5100', 68), ('5100', 69), ('5100', 70),
('5100', 71), ('5100', 72), ('5100', 73), ('5100', 74), ('5100', 75),
('5100', 76), ('5100', 77), ('5100', 78), ('5100', 79), ('5100', 80),
('5100', 81), ('5100', 82), ('5100', 83), ('5100', 84), ('5100', 85),
('5100', 86), ('5100', 87), ('5100', 88), ('5100', 89), ('5100', 90),
('5100', 91), ('5100', 92), ('5100', 93), ('5100', 94), ('5100', 95),
('5100', 96), ('5100', 97), ('5100', 98), ('5100', 99), ('5100', 100),
('5100', 101), ('5100', 102), ('5100', 103), ('5100', 104), ('5100', 105),
('5100', 106), ('5100', 107), ('5100', 108), ('5100', 109), ('5100', 110),
('5100', 111), ('5100', 112), ('5100', 113), ('5100', 114), ('5100', 115),
('5100', 116), ('5100', 117), ('5100', 118), ('5100', 119), ('5100', 120),
('5100', 121), ('5100', 122), ('5100', 123), ('5100', 124), ('5100', 125),
('5100', 126), ('5100', 127), ('5100', 128), ('5100', 129), ('5100', 130),
('5100', 131), ('5100', 132), ('5100', 133), ('5100', 134), ('5100', 135),
('5100', 136), ('5100', 137), ('5100', 138), ('5100', 139);

-- Account code 2103 (second organization mappings)
INSERT INTO temp_sub_tree_mapping (account_code, sub_tree_id) VALUES
('2103', 1093), ('2103', 1094), ('2103', 1095), ('2103', 1096), ('2103', 1097),
('2103', 1098), ('2103', 1099), ('2103', 1100), ('2103', 1101), ('2103', 1102),
('2103', 1103), ('2103', 1104), ('2103', 1105), ('2103', 1106), ('2103', 1107),
('2103', 1108), ('2103', 1109), ('2103', 1110), ('2103', 1111), ('2103', 1112),
('2103', 1113), ('2103', 1114), ('2103', 1115), ('2103', 1116), ('2103', 1117),
('2103', 1118), ('2103', 1119), ('2103', 1120), ('2103', 1121), ('2103', 1122),
('2103', 1123), ('2103', 1124), ('2103', 1125), ('2103', 1126), ('2103', 1127),
('2103', 1128), ('2103', 1129), ('2103', 1130), ('2103', 1131), ('2103', 1132),
('2103', 1133), ('2103', 1134), ('2103', 1135), ('2103', 1136), ('2103', 1137),
('2103', 1138), ('2103', 1139), ('2103', 1140), ('2103', 1141), ('2103', 1142),
('2103', 1143), ('2103', 1144), ('2103', 1145), ('2103', 1146), ('2103', 1147),
('2103', 1148), ('2103', 1149), ('2103', 1150), ('2103', 1151), ('2103', 1152),
('2103', 1153), ('2103', 1154), ('2103', 1155), ('2103', 1156), ('2103', 1157),
('2103', 1158), ('2103', 1159), ('2103', 1160);

-- Additional mappings from the provided data
INSERT INTO temp_sub_tree_mapping (account_code, sub_tree_id) VALUES
('22104', 5174), ('22104', 5175), ('22104', 5176), ('22104', 5177), ('22104', 5178),
('22104', 5179), ('22104', 5180), ('22104', 5181), ('22104', 5182), ('22104', 5183),
('22104', 5184), ('22104', 5185), ('22104', 5186), ('22104', 5187), ('22104', 5188),
('22104', 5189), ('22104', 5190), ('22104', 5191), ('22104', 5192), ('22104', 5193),
('22104', 5194), ('22104', 5195), ('22104', 5196), ('22104', 5197), ('22104', 5198),
('22104', 5199), ('22104', 5200), ('22104', 5201), ('22104', 5202), ('22104', 5204),
('22104', 5205), ('22104', 5206), ('22104', 5207), ('22104', 5209), ('22104', 5210),
('22104', 5211), ('22104', 5212), ('22104', 5213), ('22104', 5214), ('22104', 5215),
('22104', 5216), ('22104', 5217), ('22104', 5218), ('22104', 5219), ('22104', 5220),
('22104', 5221), ('22104', 5222), ('22104', 5223), ('22104', 5224), ('22104', 5225),
('31001', 5000), ('31001', 5001), ('31001', 5002), ('31001', 5003), ('31001', 5004),
('31001', 5005), ('31001', 5006), ('31001', 5007), ('31001', 5008), ('31001', 5009),
('22104', 7000), ('22104', 7001), ('22104', 7002), ('22104', 7003), ('22104', 7004),
('22104', 7005), ('22104', 7006), ('22104', 7007), ('22104', 7008), ('22104', 7009),
('22104', 7010), ('22104', 7011), ('22104', 7012), ('22104', 7013),
('12304', 2000), ('12304', 2001), ('12304', 2002), ('12304', 2003), ('12304', 2004),
('12304', 2005), ('12304', 2006), ('12304', 2007);

-- Now perform the update using the temporary tables
UPDATE public.sub_tree st
SET linked_account_id = tam.account_id,
    updated_at = NOW()
FROM temp_sub_tree_mapping tsm
JOIN temp_account_mapping tam ON tsm.account_code = tam.account_code
WHERE st.id = tsm.sub_tree_id::uuid
  AND st.linked_account_id IS NULL;

-- Verify the update
SELECT 
  COUNT(*) as total_sub_tree_rows,
  COUNT(CASE WHEN linked_account_id IS NOT NULL THEN 1 END) as with_linked_account,
  COUNT(CASE WHEN linked_account_id IS NULL THEN 1 END) as without_linked_account
FROM public.sub_tree;

COMMIT;
