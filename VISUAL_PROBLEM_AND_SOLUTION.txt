================================================================================
                    VISUAL PROBLEM AND SOLUTION
================================================================================

PROBLEM: WHY YOU GOT 1,030 LINES INSTEAD OF 699
================================================

TRANSACTIONS TABLE (BEFORE FIX):
--------------------------------
reference_number | id (UUID)                              | created_at
-----------------|----------------------------------------|------------------
1                | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa  | 2024-01-01 10:00
2                | bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb  | 2024-01-01 10:01
10               | cccccccc-cccc-cccc-cccc-cccccccccccc  | 2024-01-01 10:02  â† DUPLICATE!
10               | dddddddd-dddd-dddd-dddd-dddddddddddd  | 2024-01-02 15:30  â† DUPLICATE!
12               | eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee  | 2024-01-01 10:03  â† DUPLICATE!
12               | ffffffff-ffff-ffff-ffff-ffffffffffff  | 2024-01-02 15:31  â† DUPLICATE!
...

Total: 2,958 transactions
Unique reference_numbers: 2,161
Duplicates: 797 (27%)


CSV DATA (Part 01):
-------------------
txn_ref | account_id | debit    | credit
--------|------------|----------|----------
1       | acc-001    | 100.00   | 0.00
1       | acc-002    | 0.00     | 100.00
10      | acc-003    | 50.00    | 0.00      â† This reference has 2 transactions!
10      | acc-004    | 0.00     | 50.00     â† This reference has 2 transactions!
12      | acc-005    | 75.00    | 0.00      â† This reference has 2 transactions!
12      | acc-006    | 0.00     | 75.00     â† This reference has 2 transactions!
...

Expected lines: 699


WHAT HAPPENS DURING IMPORT:
---------------------------

SQL: JOIN transactions t ON t.reference_number = csv.txn_ref

For reference "10":
  CSV has 2 lines (50.00 debit, 50.00 credit)
  Transactions table has 2 records (cccc... and dddd...)
  JOIN creates: 2 CSV lines Ã— 2 transactions = 4 lines!
  
  Result:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ transaction_id = cccccccc... | account = acc-003 | debit = 50.00  â”‚
  â”‚ transaction_id = cccccccc... | account = acc-004 | credit = 50.00 â”‚
  â”‚ transaction_id = dddddddd... | account = acc-003 | debit = 50.00  â”‚ â† DUPLICATE!
  â”‚ transaction_id = dddddddd... | account = acc-004 | credit = 50.00 â”‚ â† DUPLICATE!
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

For reference "12":
  CSV has 2 lines (75.00 debit, 75.00 credit)
  Transactions table has 2 records (eeee... and ffff...)
  JOIN creates: 2 CSV lines Ã— 2 transactions = 4 lines!

This happens for ALL 797 duplicate transactions!

Result: 699 expected + 331 extra = 1,030 lines (47% more!)


SOLUTION: REMOVE DUPLICATE TRANSACTIONS
========================================

STEP 1: Run FIX_DUPLICATE_TRANSACTIONS_FINAL.sql
-------------------------------------------------

This SQL:
1. Identifies duplicates (797 transactions)
2. Keeps the OLDEST transaction for each reference_number
3. Deletes the newer duplicates

TRANSACTIONS TABLE (AFTER FIX):
-------------------------------
reference_number | id (UUID)                              | created_at
-----------------|----------------------------------------|------------------
1                | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa  | 2024-01-01 10:00
2                | bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb  | 2024-01-01 10:01
10               | cccccccc-cccc-cccc-cccc-cccccccccccc  | 2024-01-01 10:02  âœ“ KEPT (oldest)
                 | [dddddddd deleted]                     |                   âœ— DELETED
12               | eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee  | 2024-01-01 10:03  âœ“ KEPT (oldest)
                 | [ffffffff deleted]                     |                   âœ— DELETED
...

Total: 2,161 transactions (797 deleted)
Unique reference_numbers: 2,161
Duplicates: 0 âœ“


STEP 2: Delete All Transaction Lines
-------------------------------------

DELETE FROM transaction_lines WHERE org_id = '...';

Result: 0 lines remaining


STEP 3: Reimport Transaction Lines
-----------------------------------

Now when Part 01 runs:

SQL: JOIN transactions t ON t.reference_number = csv.txn_ref

For reference "10":
  CSV has 2 lines (50.00 debit, 50.00 credit)
  Transactions table has 1 record (cccc... only)
  JOIN creates: 2 CSV lines Ã— 1 transaction = 2 lines âœ“
  
  Result:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ transaction_id = cccccccc... | account = acc-003 | debit = 50.00  â”‚
  â”‚ transaction_id = cccccccc... | account = acc-004 | credit = 50.00 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

For reference "12":
  CSV has 2 lines (75.00 debit, 75.00 credit)
  Transactions table has 1 record (eeee... only)
  JOIN creates: 2 CSV lines Ã— 1 transaction = 2 lines âœ“

Result: Exactly 699 lines as expected! âœ“


FINAL RESULT AFTER ALL 20 PARTS:
=================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Transactions:        2,161 (unique)                            â”‚
â”‚  Transaction Lines:   13,963                                    â”‚
â”‚  Total Debit:         905,925,674.84                            â”‚
â”‚  Total Credit:        905,925,674.84                            â”‚
â”‚  Balance:             0.00 âœ“                                    â”‚
â”‚                                                                 â”‚
â”‚  Dimensions:                                                    â”‚
â”‚    Classification:    13,743 (98.4%)                            â”‚
â”‚    Project:           13,963 (100.0%)                           â”‚
â”‚    Analysis:          13,369 (95.7%)                            â”‚
â”‚    Sub-tree:          13,963 (100.0%)                           â”‚
â”‚                                                                 â”‚
â”‚  Status:              âœ… ALL VERIFICATIONS PASSED               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


COMPARISON:
===========

BEFORE FIX:
-----------
Transactions:     2,958 (797 duplicates)
Part 01 Result:   1,030 lines (331 extra, 47% more)
Status:           âŒ INCORRECT

AFTER FIX:
----------
Transactions:     2,161 (no duplicates)
Part 01 Result:   699 lines (exactly as expected)
Status:           âœ… CORRECT


KEY INSIGHT:
============

The problem was NOT in the SQL files or CSV data.
The problem was DUPLICATE TRANSACTIONS in the database.

When you have:
  - 1 transaction with reference "10" â†’ JOIN creates correct number of lines
  - 2 transactions with reference "10" â†’ JOIN creates DOUBLE the lines
  - 3 transactions with reference "10" â†’ JOIN creates TRIPLE the lines

Solution: Keep only 1 transaction per reference_number!


NEXT ACTION:
============

ğŸ‘‰ Run: FIX_DUPLICATE_TRANSACTIONS_FINAL.sql
ğŸ‘‰ Verify: Deleted 797, Kept 2,161
ğŸ‘‰ Delete all transaction_lines
ğŸ‘‰ Reimport all 20 parts
ğŸ‘‰ Part 01 should show 699 lines âœ“

================================================================================
